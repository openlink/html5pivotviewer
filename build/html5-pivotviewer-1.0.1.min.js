/*! html5-pivotviewer v1.0.1 | Built 2014-03-10 | Licence https://github.com/RogerNoble/html5pivotviewer/blob/develop/LICENSE */
var global={},PivotViewer=PivotViewer||{};PivotViewer.Version="@VERSION@",PivotViewer.Models={},PivotViewer.Models.Loaders={},PivotViewer.Utils={},PivotViewer.Views={};var Debug=Debug||{};!function(a){var b={};a.publish=function(c,d){b[c]&&a.each(b[c],function(){this.apply(a,d||[])})},a.subscribe=function(a,c){return b[a]||(b[a]=[]),b[a].push(c),[a,c]},a.unsubscribe=function(c){var d=c[0];b[d]&&a.each(b[d],function(a){this==c[1]&&b[d].splice(a,1)})}}(jQuery),Debug.Log=function(a){window.console&&window.console.log&&"undefined"!=typeof debug&&1==debug&&window.console.log(a)},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),PivotViewer.Utils.EscapeMetaChars=function(a){return a.replace(/\|/gi,"\\|").replace(/\//gi,"\\/").replace(/'/gi,"\\'").replace(/,/gi,"\\,").replace(/:/gi,"\\:").replace(/\(/gi,"\\(").replace(/\)/gi,"\\)").replace(/\+/gi,"\\+").replace(/\+/gi,"\\-").replace(/\+/gi,"\\_").replace(/\+/gi,"\\%")},PivotViewer.Utils.EscapeItemId=function(a){return a.replace(/\s+/gi,"|").replace(/'/gi,"").replace(/\(/gi,"").replace(/\)/gi,"").replace(/\./gi,"")},PivotViewer.Utils.HtmlSpecialChars=function(a){return jQuery("<div />").text(a).html()},PivotViewer.Utils.Now=function(){return Date.now?Date.now():(new Date).getTime()},PivotViewer.Utils.Min=function(a){for(var b=1e6,c=0,d=a.length;d>c;c++)b=b>a[c]?a[c]:b;return b},PivotViewer.Utils.Max=function(a){for(var b=-1e6,c=0,d=a.length;d>c;c++)b=b<a[c]?a[c]:b;return b},PivotViewer.Utils.Histogram=function(a){if(!a instanceof Array)return null;var b=PivotViewer.Utils.Min(a),c=PivotViewer.Utils.Max(a),d=2*(Math.floor(Math.pow(2*a.length,1/3))+1);d>10&&(d=10);for(var e=(c+1-(b-1))/d,f=[],g=0;d>g;g++){var h=b+g*e,i=b+(g+1)*e;f.push([]);for(var j=0,k=a.length;k>j;j++)h<=a[j]&&i>a[j]&&f[g].push(a[j])}return{Histogram:f,Min:b,Max:c,BinCount:d}},function(){var a=!1,b=/xyz/.test(function(){})?/\b_super\b/:/.*/;Object.subClass=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.constructor=d,d.subClass=arguments.callee,d}}(),PivotViewer.Models.Collection=Object.subClass({init:function(){this.CollectionName="",this.BrandImage="",this.FacetCategories=[],this.Items=[],this.CXMLBase="",this.ImageBase="",this.CopyrightName="",this.CopyrightHref="",this.MaxRelatedLinks=0},GetItemById:function(a){for(var b=0;b<this.Items.length;b++)if(this.Items[b].Id==a)return this.Items[b];return null},GetFacetCategoryByName:function(a){for(var b=0;b<this.FacetCategories.length;b++)if(this.FacetCategories[b].Name==a)return this.FacetCategories[b];return null}}),PivotViewer.Models.FacetCategory=Object.subClass({init:function(a,b,c,d,e,f){this.Name=a,this.Format=b,this.Type=null!=c&&void 0!=c?c:PivotViewer.Models.FacetType.String,this.IsFilterVisible=null!=d&&void 0!=d?d:!0,this.IsMetaDataVisible=null!=e&&void 0!=e?e:!0,this.IsWordWheelVisible=null!=f&&void 0!=f?f:!0,this.CustomSort,this.decadeBuckets=[],this.yearBuckets=[],this.monthBuckets=[],this.dayBuckets=[],this.hourBuckets=[],this.minuteBuckets=[],this.secondBuckets=[]}}),PivotViewer.Models.FacetCategorySort=Object.subClass({init:function(a){this.Name=a,this.SortValues=[]}}),PivotViewer.Models.Item=Object.subClass({init:function(a,b,c,d){this.Img=parseInt(a),this.Id=b,this.Href=c,this.Name=d,this.Description,this.Facets=[],this.Links=[]}}),PivotViewer.Models.ItemLink=Object.subClass({init:function(a,b){this.Name=a,this.Href=b}}),PivotViewer.Models.Facet=Object.subClass({init:function(a){this.Name=a,this.FacetValues=[]},AddFacetValue:function(a){this.FacetValues.push(a)}}),PivotViewer.Models.FacetValue=Object.subClass({init:function(a){this.Value=a,this.Href=""}}),PivotViewer.Models.DateTimeInfo=Object.subClass({init:function(a,b){this.Name=a,this.StartDate=b,this.Items=[]}}),PivotViewer.Models.FacetType={String:"String",LongString:"LongString",Number:"Number",DateTime:"DateTime",Link:"Link"},PivotViewer.Models.Loaders.ICollectionLoader=Object.subClass({init:function(){},LoadCollection:function(a){if(!a instanceof PivotViewer.Models.Collection)throw"collection not an instance of PivotViewer.Models.Collection."}}),PivotViewer.Models.Loaders.CXMLLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(a,b){this.CXMLUriNoProxy=a,this.CXMLUri=b?b+a:a},LoadCollection:function(a){var a=a;this._super(a),a.CXMLBaseNoProxy=this.CXMLUriNoProxy,a.CXMLBase=this.CXMLUri,$.ajax({type:"GET",url:this.CXMLUri,dataType:"xml",success:function(b){Debug.Log("CXML loaded");var c=$(b).find("Collection")[0],d=0,e="P";if(void 0==c){$(".pv-loading").remove();var f="";f+="Error parsing CXML Collection<br>",f+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-parse-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+f+"</p></div></div>");{setTimeout(function(){window.open("#pv-parse-error","_self")},1e3)}throw"Error parsing CXML Collection"}for(var g=0;g<c.attributes.length;g++)if("http://schemas.microsoft.com/livelabs/pivot/collection/2009"==c.attributes[g].value){e=void 0!=c.attributes[g].localName?c.attributes[g].localName:c.attributes[g].baseName;break}a.CollectionName=$(c).attr("Name"),a.BrandImage=void 0!=$(c).attr(e+":BrandImage")?$(c).attr(e+":BrandImage"):"";var h=$(b).find("FacetCategory");A=e;for(var g=0;g<h.length;g++){for(var i=$(h[g]),j=0;j<i[0].attributes.length;j++)if("http://schemas.microsoft.com/livelabs/pivot/collection/2009"==i[0].attributes[j].value){e=void 0!=i[0].attributes[j].localName?i[0].attributes[j].localName:i[0].attributes[j].baseName;break}var k=new PivotViewer.Models.FacetCategory(i.attr("Name"),i.attr("Format"),i.attr("Type"),void 0!=i.attr(e+":IsFilterVisible")?"true"==i.attr(e+":IsFilterVisible").toLowerCase()?!0:!1:!0,void 0!=i.attr(e+":IsMetaDataVisible")?"true"==i.attr(e+":IsMetaDataVisible").toLowerCase()?!0:!1:!0,void 0!=i.attr(e+":IsWordWheelVisible")?"true"==i.attr(e+":IsWordWheelVisible").toLowerCase()?!0:!1:!0),l=i.find(e+"\\:SortOrder"),m=l.find(e+"\\:SortValue");if(0==l.length&&(l=i.find("SortOrder"),m=l.find("SortValue")),1==l.length){for(var n=new PivotViewer.Models.FacetCategorySort(l.attr("Name")),j=0;j<m.length;j++)n.SortValues.push($(m[j]).attr("Value"));k.CustomSort=n}a.FacetCategories.push(k),e=A}var o=$(b).find("Items");if(1==o.length){a.ImageBase=$(o[0]).attr("ImgBase");var p=$(o[0]).find("Item");if(0==p.length){$(".pv-loading").remove();var f="";f+="There are no items in the CXML Collection<br><br>",$(".pv-wrapper").append('<div id="pv-empty-collection-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+f+"</p></div></div>");{setTimeout(function(){window.open("#pv-empty-collection-error","_self")},1e3)}}else for(var g=0;g<p.length;g++){var q=new PivotViewer.Models.Item($(p[g]).attr("Img").replace("#",""),$(p[g]).attr("Id"),$(p[g]).attr("Href"),$(p[g]).attr("Name")),r=$(p[g]).find("Description");1==r.length&&r[0].childNodes.length&&(q.Description=PivotViewer.Utils.HtmlSpecialChars(r[0].childNodes[0].nodeValue));for(var s=$(p[g]).find("Facet"),j=0;j<s.length;j++){for(var t=new PivotViewer.Models.Facet($(s[j]).attr("Name")),u=$(s[j]).children(),v=0;v<u.length;v++)if(1==u[v].nodeType){var w=$.trim($(u[v]).attr("Value"));if(null==w||""==w)if("Link"==u[v].nodeName)if(""==$(u[v]).attr("Href")||null==$(u[v]).attr("Href")){var y=new PivotViewer.Models.FacetValue(PivotViewer.Utils.HtmlSpecialChars("(empty Link)"));t.AddFacetValue(y)}else if(""==$(u[v]).attr("Name")||null==$(u[v]).attr("Name")){var y=new PivotViewer.Models.FacetValue("(unnamed Link)");y.Href=$(u[v]).attr("Href"),t.AddFacetValue(y)}else{var y=new PivotViewer.Models.FacetValue($(u[v]).attr("Name"));y.Href=$(u[v]).attr("Href"),t.AddFacetValue(y)}else{var y=new PivotViewer.Models.FacetValue(PivotViewer.Utils.HtmlSpecialChars("(empty "+u[v].nodeName+")"));t.AddFacetValue(y)}else if("Number"==u[v].nodeName){var y=new PivotViewer.Models.FacetValue(parseFloat(w));t.AddFacetValue(y)}else{var y=new PivotViewer.Models.FacetValue(PivotViewer.Utils.HtmlSpecialChars(w));t.AddFacetValue(y)}}q.Facets.push(t)}var z=$(p[g]).find("Extension");if(1==z.length){for(var A=e,j=0;j<z[0].children.length&&!(e=z[0].children[0].lookupPrefix("http://schemas.microsoft.com/livelabs/pivot/collection/2009"));j++);var B=$(z[0]).find(e+"\\:Related, Related");if(1==B.length){for(var C=$(B[0]).find(e+"\\:Link, Link"),D=0;D<C.length;D++){var E=$(C[D]).attr("Name"),F=$(C[D]).attr("Href");if(-1==F.indexOf(".cxml")&&F.indexOf("pivot.vsp")>=0){var G=$.url(this.url);F=G.attr("protocol")+"://"+G.attr("authority")+G.attr("directory")+F}var H=new PivotViewer.Models.ItemLink(E,F);q.Links.push(H)}C.length>d&&(d=C.length)}e=A}a.Items.push(q)}}a.MaxRelatedLinks=d;var I=$(b).find("Extension");if(I.length>1)for(x=0;x<I.length;x++){for(var A=e,j=0;j<I[x].children.length&&!(e=I[0].children[0].lookupPrefix("http://schemas.microsoft.com/livelabs/pivot/collection/2009"));j++);var J=$(I[x]).find(e+"\\:Copyright, Copyright");if(J.length>0){a.CopyrightName=$(J[0]).attr("Name"),a.CopyrightHref=$(J[0]).attr("Href");break}e=A}$.publish("/PivotViewer/Models/Collection/Loaded",null)},error:function(a,b,c){$(".pv-loading").remove();var d="";d+="Error loading CXML Collection<br><br>",d=d+"URL        : "+this.url+"<br>",d=d+"Status : "+a.status+" "+c+"<br>",d=d+"Details    : "+a.responseText+"<br>",d+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-loading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+d+"</p></div></div>");setTimeout(function(){window.open("#pv-loading-error","_self")},1e3)}})}}),PivotViewer.Views.IPivotViewerView=Object.subClass({init:function(){this.isActive=!1,this.init=!0,this.selected="",this.tiles=[]},Setup:function(){},Filter:function(){},GetUI:function(){return""},GetButtonImage:function(){return""},GetButtonImageSelected:function(){return""},GetViewName:function(){return""},Activate:function(){this.isActive=!0},Deactivate:function(){this.isActive=!1}}),PivotViewer.Views.TileBasedView=PivotViewer.Views.IPivotViewerView.subClass({OffsetTiles:function(a,b){for(var c=0;c<this.tiles.length;c++){var d=$.inArray(this.tiles[c].facetItem.Id,this.currentFilter);d>=0&&(this.tiles[c]._locations[0].destinationx+=a,this.tiles[c]._locations[0].destinationy+=b)}},SetInitialTiles:function(a,b,c){for(var d=b/2,e=c/2,f=0;f<a.length;f++)a[f]._locations[0].x=d,a[f]._locations[0].y=e,a[f].velocityx=0,a[f].velocityy=0,a[f]._locations[0].startx=d,a[f]._locations[0].starty=e,a[f]._locations[0].destinationx=0,a[f]._locations[0].destinationy=0,a[f].width=1,a[f].height=1},GetRowsAndColumns:function(a,b,c,d){var e=.7,f=c*(d-Math.pow(e,2)),g=(b+a*c)*e,h=-1*b*a,i=(-1*g+Math.sqrt(Math.pow(g,2)-4*f*h))/(2*f),j=Math.floor(i*c),k=Math.ceil(b/j),l=Math.floor(a/i),m=a-l*i;return{Rows:k,Columns:l,TileMaxWidth:i,TileHeight:j,PaddingX:m}},SetOuterTileDestination:function(a,b,c){var d=c._locations[0].x-a/2,e=c._locations[0].y-b/2,f=Math.atan2(e,d);c._locations[0].destinationx=a*Math.cos(f)+a/2,c._locations[0].destinationy=b*Math.sin(f)+b/2},SortBy:function(a,b,c,d){var e=function(b,d){if(c)for(var e=b.facetItem.Facets.length-1;e>-1;e-=1)if(b.facetItem.Facets[e].Name==a&&b.facetItem.Facets[e].FacetValues.length>0){if($.isNumeric(b.facetItem.Facets[e].FacetValues[0].Value))return c(b.facetItem.Facets[e].FacetValues[0].Value);for(var f=0;f<b.facetItem.Facets[e].FacetValues.length;f++)if(d.length>0)for(var g=0;g<d.length;g++)if(d[g].facet==a)for(var h=0;h<d[g].facetValue.length;h++)if(b.facetItem.Facets[e].FacetValues[f].Value==d[g].facetValue[h])return c(b.facetItem.Facets[e].FacetValues[f].Value);return c(b.facetItem.Facets[e].FacetValues[0].Value)}return null};return function(a,c){var f=e(a,d),g=e(c,d);return(g>f?-1:f>g?1:0)*[1,-1][+!!b]}}}),PivotViewer.Views.DataView=PivotViewer.Views.IPivotViewerView.subClass({init:function(){this._super()},Setup:function(){},Filter:function(){},GetUI:function(){return""},GetButtonImage:function(){return""},GetButtonImageSelected:function(){return""},GetViewName:function(){return"Grid View"}}),PivotViewer.Views.GraphView=PivotViewer.Views.TileBasedView.subClass({init:function(){this._super();var a=this;this.buckets=[],this.Scale=1,this.canvasHeightUIAdjusted=0,this.titleSpace=62,this.dontZoom=!1,$.subscribe("/PivotViewer/Views/Canvas/Click",function(b){if(a.isActive){for(var c=null,d=null,e=null,f=0;f<a.tiles.length;f++){var g=a.tiles[f].Contains(b.x,b.y);g>=0?(d=a.tiles[f],c=a.tiles[f].facetItem.Id,e=g):a.tiles[f].Selected(!1)}a.handleSelection(c,d,b.x,e)}}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(b){if(a.isActive){$(".pv-viewarea-graphview-overlay-bucket").removeClass("graphview-bucket-hover");var c=Math.floor((b.x-a.offsetX)/a.columnWidth),d=$("#pv-viewarea-graphview-overlay-bucket-"+c);d.addClass("graphview-bucket-hover");for(var e=0;e<a.tiles.length;e++){var f=a.tiles[e].Contains(b.x,b.y);f>=0?(a.tiles[e].Selected(!0),a.tiles[e].selectedLoc=f):a.tiles[e].Selected(!1)}}}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(b){if(a.isActive){if(a.dontZoom)return void(a.dontZoom=!1);{var c=a.Scale;a.currentWidth,a.currentHeight,void 0!=b.scale?0:1e3}void 0!=b.scale?b.scale>=1?a.Scale+=b.scale-1:(a.Scale-=b.scale,a.Scale=a.Scale<1?1:a.Scale):void 0!=b.delta&&(a.Scale=0==b.delta?1:a.Scale+b.delta-1),0/0==a.Scale&&(a.Scale=1);var d=(a.width-a.offsetX)*a.Scale,e=a.height*a.Scale;if(d<a.width||1==a.Scale)a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY,a.currentWidth=a.width,a.currentHeight=a.height,a.canvasHeightUIAdjusted=a.height-a.offsetY-a.titleSpace,a.columnWidth=(a.width-a.offsetX)/a.buckets.length,a.Scale=1,$(".pv-viewarea-graphview-overlay div").fadeIn("slow"),a.dontZoom=!0,$(".pv-toolbarpanel-zoomslider").slider("option","value",0);else{a.currentOffsetX=b.x-(b.x-a.currentOffsetX)/c*a.Scale;var f=(b.y-a.currentOffsetY)/c*a.Scale;a.currentOffsetY=b.y-f,a.canvasHeightUIAdjusted=e-(a.offsetY+a.titleSpace)/c*a.Scale,a.currentWidth=d,a.currentHeight=e,a.columnWidth=d/a.buckets.length,$(".pv-viewarea-graphview-overlay div").fadeOut("slow")}if(a.rowscols=a.GetRowsAndColumns(a.columnWidth-2,a.canvasHeightUIAdjusted,a.maxRatio,a.bigCount),a.rowscols.TileHeight<10&&(a.rowscols.TileHeight=10),a.SetVisibleTileGraphPositions(a.rowscols,a.currentOffsetX,a.currentOffsetY,!0,!0),1==a.Scale&&1!=c){for(var g=0;g<a.tiles.length;g++)a.tiles[g].Selected(!1),a.tiles[g].selectedLoc=0;a.selected="",$.publish("/PivotViewer/Views/Item/Selected",[{id:a.selected,bkt:0}])}}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(b){if(a.isActive){var c=b.x,d=b.y,e=!1,f=!1;a.currentOffsetX+=c,a.currentOffsetY+=d,c>0&&a.currentOffsetX>a.offsetX&&(a.currentOffsetX-=c,e=!0),d>0&&a.currentOffsetY+a.canvasHeightUIAdjusted>a.currentHeight+a.offsetY&&(a.currentOffsetY-=d,f=!0),a.currentOffsetX<a.offsetX&&a.currentWidth==a.width&&(a.currentOffsetX-=c,e=!0),0>c&&a.currentOffsetX<-1*(a.currentWidth-a.width)&&(a.currentOffsetX-=c,e=!0),a.currentOffsetY<a.offsetY&&a.currentHeight==a.height&&(a.currentOffsetY-=d,f=!0),0>d&&a.currentOffsetY-a.offsetY<-1*(a.currentHeight-a.height)&&(a.currentOffsetY-=d,f=!0),e&&f||(e?a.OffsetTiles(0,d):f?a.OffsetTiles(c,0):a.OffsetTiles(c,d))}})},Setup:function(a,b,c,d,e){this.width=a,this.height=b,this.offsetX=c,this.offsetY=d,this.maxRatio=e,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,this.rowscols=null,this.bigCount=0},Filter:function(a,b,c,d,e){var f=this;if(Modernizr.canvas){Debug.Log("Graph View Filtered: "+b.length),this.changingView=!1,e&&($(".pv-tableview-table").is(":visible")&&($(".pv-tableview-table").fadeOut(),$(".pv-tableview-table").fadeOut(),$(".pv-toolbarpanel-zoomslider").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","1px"),$(".pv-viewarea-canvas").fadeIn()),$(".pv-mapview-canvas").is(":visible")&&($(".pv-mapview-canvas").fadeOut(),$(".pv-toolbarpanel-zoomslider").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","1px"),$(".pv-viewarea-canvas").fadeIn()),$(".pv-timeview-canvas").is(":visible")&&($(".pv-timeview-canvas").fadeOut(),$(".pv-toolbarpanel-timelineselector").fadeOut(),$(".pv-toolbarpanel-sort").fadeIn(),$(".pv-toolbarpanel-zoomslider").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","1px"),$("#MAIN_BODY").css("overflow","auto"),$(".pv-viewarea-canvas").fadeIn())),this.sortFacet=c,this.tiles=a,this.tiles=a.sort(this.SortBy(this.sortFacet,!1,function(a){return $.isNumeric(a)?a:a.toUpperCase()},d)),this.currentFilter=b,this.buckets=this.Bucketize(a,b,this.sortFacet,d),this.columnWidth=(this.width-this.offsetX)/this.buckets.length,this.canvasHeightUIAdjusted=this.height-this.offsetY-this.titleSpace;var g=[];this.bigCount=0;for(var h=0;h<this.buckets.length;h++){var i=h%2==0?"graphview-bucket-dark":"graphview-bucket-light";g[h]="<div class='pv-viewarea-graphview-overlay-bucket "+i+"' id='pv-viewarea-graphview-overlay-bucket-"+h+"' style='width: "+(Math.floor(this.columnWidth)-4)+"px; height:"+(this.height-2)+"px; left:"+(h*this.columnWidth-2)+"px;'>",g[h]+=this.buckets[h].startRange==this.buckets[h].endRange?"<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[h].startRange+"</div>":"<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[h].startRange+"<br/>to<br/>"+this.buckets[h].endRange+"</div>",g[h]+="<span class='pv-viewarea-graphview-overlay-count' style='top: "+(this.canvasHeightUIAdjusted-39)+"px;'>"+this.buckets[h].Ids.length+"</span>",g[h]+="</div>",this.bigCount<this.buckets[h].Ids.length&&(this.bigCount=this.buckets[h].Ids.length)}var j=$(".pv-viewarea-graphview-overlay");j.css("left",this.offsetX+"px"),$(".pv-viewarea-graphview-overlay div").fadeOut("slow",function(){$(this).remove()}),j.append(g.join("")),$(".pv-viewarea-graphview-overlay div").fadeIn("slow");for(var h=0;h<this.tiles.length;h++){this.tiles[h]._locations[0].startx=this.tiles[h]._locations[0].x,this.tiles[h]._locations[0].starty=this.tiles[h]._locations[0].y,this.tiles[h].startwidth=this.tiles[h].width,this.tiles[h].startheight=this.tiles[h].height;var k=$.inArray(this.tiles[h].facetItem.Id,b);0>k&&(this.SetOuterTileDestination(this.width,this.height,this.tiles[h]),this.tiles[h].start=PivotViewer.Utils.Now(),this.tiles[h].end=this.tiles[h].start+1e3)}f.maxRatio=f.tiles[0]._controller.GetRatio(f.tiles[0].facetItem.Img);for(var h=0;h<f.tiles.length;h++){var k=$.inArray(f.tiles[h].facetItem.Id,b);k>=0&&f.tiles[h]._controller.GetRatio(f.tiles[h].facetItem.Img)<f.maxRatio&&(f.maxRatio=f.tiles[h]._controller.GetRatio(f.tiles[h].facetItem.Img))}var l=b.length==this.tiles.length?0:500;setTimeout(function(){var a=$(".pv-toolbarpanel-zoomslider").slider("option","value");a>0&&(this.selected=selectedItem="",this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",1)),f.rowscols=f.GetRowsAndColumns(f.columnWidth-2,f.canvasHeightUIAdjusted-f.offsetY,f.maxRatio,f.bigCount),f.rowscols.TileHeight<10&&(f.rowscols.TileHeight=10);for(var b=0;b<f.tiles.length;b++)f.tiles[b].origwidth=f.rowscols.TileHeight/f.tiles[b]._controller.GetRatio(f.tiles[b].facetItem.Img),f.tiles[b].origheight=f.rowscols.TileHeight;f.SetVisibleTileGraphPositions(f.rowscols,f.offsetX,f.offsetY,!1,!1)},l),this.init=!1}},GetUI:function(){return Modernizr.canvas?"<div class='pv-viewarea-graphview-overlay'></div>":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"images/GraphView.png"},GetButtonImageSelected:function(){return"images/GraphViewSelected.png"},GetViewName:function(){return"Graph View"},GetSortedFilter:function(){var a=[];for(i=0;i<this.buckets.length;i++)for(j=0;j<this.buckets[i].Ids.length;j++){var b=new Object;b.Id=this.buckets[i].Ids[j],b.Bucket=i,a.push(b)}return a},SetVisibleTileGraphPositions:function(a,b,c,d,e){var f=e&&this.rowscols?this.rowscols.Columns:a.Columns;e||(this.rowscols=a);for(var g=0;g<this.tiles.length;g++)for(this.tiles[g].firstFilterItemDone=!1;this.tiles[g]._locations.length>1;)this.tiles[g]._locations.pop();for(var h=0;h<this.buckets.length;h++)for(var i=0,j=0,k=0,l=this.tiles.length;l>k;k++)$.inArray(this.tiles[k].facetItem.Id,this.buckets[h].Ids)>=0&&(this.tiles[k].firstFilterItemDone?(tileLocation=new PivotViewer.Views.TileLocation,tileLocation.startx=this.tiles[k]._locations[0].startx,tileLocation.starty=this.tiles[k]._locations[0].starty,tileLocation.x=this.tiles[k]._locations[0].x,tileLocation.y=this.tiles[k]._locations[0].y,tileLocation.destinationx=h*this.columnWidth+i*a.TileMaxWidth+b,tileLocation.destinationy=this.canvasHeightUIAdjusted-a.TileHeight-j*a.TileHeight+c,this.tiles[k]._locations.push(tileLocation)):(d&&(this.tiles[k]._locations[0].startx=this.tiles[k]._locations[0].x,this.tiles[k]._locations[0].starty=this.tiles[k]._locations[0].y,this.tiles[k].startwidth=this.tiles[k].width,this.tiles[k].startheight=this.tiles[k].height),this.tiles[k].destinationwidth=a.TileMaxWidth,this.tiles[k].destinationheight=a.TileHeight,this.tiles[k]._locations[0].destinationx=h*this.columnWidth+i*a.TileMaxWidth+b,this.tiles[k]._locations[0].destinationy=this.canvasHeightUIAdjusted-a.TileHeight-j*a.TileHeight+c,this.tiles[k].start=PivotViewer.Utils.Now(),this.tiles[k].end=this.tiles[k].start+1e3,this.tiles[k].firstFilterItemDone=!0),i==f-1?(i=0,j++):i++)},GetDatetimeBuckets:function(a,b,c){for(var d=[],e=[],f=0;f<a.length;f++)for(var g=($("#pv-facet-item"+CleanName(c)+"__"+CleanName(a[f].Name.toString())),0);g<b.length;g++)if(-1!=a[f].Items.indexOf(b[g])){var h=-1;if(0==d.length)d.push({startRange:a[f].Name,endRange:a[f].Name,Ids:[b[g]],Values:[a[f].Name]});else{for(var i=0;i<d.length;i++)d[i].startRange==a[f].Name&&(h=i);h>-1?d[h].Ids.push(b[g]):d.push({startRange:a[f].Name,endRange:a[f].Name,Ids:[b[g]],Values:[a[f].Name]})}e.push(b[g])}d.push({startRange:"(no info)",endRange:"(no info)",Ids:[],Values:["(no info)"]});for(var i=0;i<b.length;i++)-1==e.indexOf(b[i])&&d[d.length-1].Ids.push(b[i]);return 0==d[d.length-1].Ids.length&&d.pop(),d},Bucketize:function(a,b,c,d){var e,f=[];for(h=0;h<this.categories.length;h++)if(this.categories[h].Name==c){e=this.categories[h];break}if(e.Type==PivotViewer.Models.FacetType.DateTime){var g;return g=this.GetDatetimeBuckets(e.decadeBuckets,b,e.Name),g.length>1?g:(g=this.GetDatetimeBuckets(e.yearBuckets,b,e.Name),g.length>1?g:(g=this.GetDatetimeBuckets(e.monthBuckets,b,e.Name),g.length>1?g:(g=this.GetDatetimeBuckets(e.dayBuckets,b,e.Name),g.length>1?g:(g=this.GetDatetimeBuckets(e.hourBuckets,b,e.Name),g.length>1?g:(g=this.GetDatetimeBuckets(e.minuteBuckets,b,e.Name),g.length>1?g:g=this.GetDatetimeBuckets(e.secondBuckets,b,e.Name))))))}for(var h=0;h<a.length;h++)if($.inArray(a[h].facetItem.Id,b)>=0){for(var i=!1,j=0;j<a[h].facetItem.Facets.length;j++)if(a[h].facetItem.Facets[j].Name==c&&a[h].facetItem.Facets[j].FacetValues.length>0)for(var k=0;k<a[h].facetItem.Facets[j].FacetValues.length;k++){for(var l=a[h].facetItem.Facets[j].FacetValues[k].Value,m=!1,n=0;n<f.length;n++)f[n].startRange==l&&($.inArray(a[h].facetItem.Id,f[n].Ids)<0&&f[n].Ids.push(a[h].facetItem.Id),m=!0);m||f.push({startRange:l,endRange:l,Ids:[a[h].facetItem.Id],Values:[l]}),i=!0}if(!i){for(var l="(no info)",m=!1,n=0;n<f.length;n++)f[n].startRange==l&&(f[n].Ids.push(a[h].facetItem.Id),f[n].Values.push(l),m=!0);m||f.push({startRange:l,endRange:l,Ids:[a[h].facetItem.Id],Values:[l]})}}if(d.length>0){for(var o,p=0;p<d.length;p++)if(d[p].facet==c){o=p;break}if(void 0!=o&&o>=0){for(var q=[],r=d[o].facetValue,s=0;s<f.length;s++){var t=$.inArray(f[s].startRange,r);t>=0&&q.push(f[s])}f=q}}for(var u=0;f.length>8;)if(u<f.length-1){f[u].endRange=f[u+1].endRange;for(var h=0;h<f[u+1].Ids.length;h++)$.inArray(f[u+1].Ids[h],f[u].Ids)<0&&f[u].Ids.push(f[u+1].Ids[h]),$.inArray(f[u+1].endRange,f[u].Values)<0&&f[u].Values.push(f[u+1].endRange);f.splice(u+1,1),u++}else u=0;return f},GetSelectedCol:function(a,b){var c=this,d=0;for(i=0;b>i;i++)$.inArray(a.facetItem.Id,this.buckets[i].Ids)>0&&d++;return padding=c.rowscols.PaddingX,colsInBar=c.rowscols.Columns,tileMaxWidth=c.rowscols.TileMaxWidth,selectedBar=Math.floor((a._locations[d].x-c.currentOffsetX)/(tileMaxWidth*colsInBar+padding)),selectedColInBar=Math.round((a._locations[d].x-c.currentOffsetX-selectedBar*(colsInBar*tileMaxWidth+padding))/tileMaxWidth),selectedCol=selectedBar*colsInBar+selectedColInBar},GetSelectedRow:function(a,b){var c=this,d=0;for(i=0;b>i;i++)$.inArray(a.facetItem.Id,this.buckets[i].Ids)>0&&d++;return selectedRow=Math.round((c.canvasHeightUIAdjusted-(a._locations[d].y-c.currentOffsetY))/a.height)},CentreOnSelectedTile:function(a,b){for(var c,d=this,e=0;e<d.tiles.length;e++)if(d.tiles[e].IsSelected()){c=d.tiles[e];break}d.rowscols=d.GetRowsAndColumns(d.columnWidth-2,d.canvasHeightUIAdjusted,d.maxRatio,d.bigCount),d.rowscols.TileHeight<10&&(d.rowscols.TileHeight=10);var f=Math.floor(a/d.rowscols.Columns),g=d.rowscols.PaddingX*f;d.currentOffsetX=d.rowscols.TileMaxWidth*a*-1+d.width/2-d.rowscols.TileMaxWidth/2-g,d.currentOffsetY=-d.rowscols.TileHeight*(d.rowscols.Rows/2-(b+1))-d.canvasHeightUIAdjusted/2-d.rowscols.TileHeight/2,d.SetVisibleTileGraphPositions(d.rowscols,d.currentOffsetX,d.currentOffsetY,!0,!0)},handleSelection:function(a,b,c,d){var e=this,f=0,g=0,h=!1,i=!1;if(null!=a&&null!=b&&(selectedX=b._locations[d].x,selectedY=b._locations[d].y),null!=a&&e.selected!=a&&""==e.selected){var j=$(".pv-toolbarpanel-zoomslider").slider("option","value");0!=j&&$(".pv-toolbarpanel-zoomslider").slider("option","value",0)}if(null!=a&&null!=b&&(b.Selected(!0),b.selectedLoc=d,h=!0,padding=e.rowscols.PaddingX,colsInBar=e.rowscols.Columns,tileMaxWidth=e.rowscols.TileMaxWidth,selectedBar=Math.floor((b._locations[d].x-e.currentOffsetX)/(b.width*colsInBar+padding)),selectedColInBar=Math.round((b._locations[d].x-e.currentOffsetX-selectedBar*(colsInBar*tileMaxWidth+padding))/tileMaxWidth),f=selectedBar*colsInBar+selectedColInBar,g=Math.round((e.canvasHeightUIAdjusted-(b._locations[d].y-e.currentOffsetY))/b.height),tileHeight=b.height,tileWidth=b.height/b._controller.GetRatio(b.facetItem.Img),tileOrigHeight=b.origheight,tileOrigWidth=b.origwidth,canvasHeight=b.context.canvas.height,canvasWidth=b.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width())),null==e.selected||""==e.selected||h||(i=!0),null!=a&&e.selected!=a){if(origProportion=tileHeight/canvasHeight>tileWidth/canvasWidth?tileOrigHeight/canvasHeight:tileOrigWidth/canvasWidth,scale=Math.round(.75/origProportion*2),""==e.selected){var j=$(".pv-toolbarpanel-zoomslider").slider("option","value");j=scale,$(".pv-toolbarpanel-zoomslider").slider("option","value",j)}e.selected=a,e.CentreOnSelectedTile(f,g),$(".pv-viewarea-graphview-overlay div").fadeOut("slow")}else{e.selected=a="",selectedBar=0,e.currentOffsetX=e.offsetX,e.currentOffsetY=e.offsetY;var j=$(".pv-toolbarpanel-zoomslider").slider("option","value");j=0,$(".pv-toolbarpanel-zoomslider").slider("option","value",j),$(".pv-viewarea-graphview-overlay div").fadeIn("slow")}if($.publish("/PivotViewer/Views/Item/Selected",[{id:a,bkt:selectedBar}]),!h&&!i){var k=Math.floor((c-e.offsetX)/e.columnWidth);$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:e.sortFacet,Item:e.buckets[k].startRange,MaxRange:e.buckets[k].endRange,Values:e.buckets[k].Values,ClearFacetFilters:!0}])}},SetFacetCategories:function(a){this.categories=a.FacetCategories}}),PivotViewer.Views.GridView=PivotViewer.Views.TileBasedView.subClass({init:function(){this.Scale=1,this._super(),this.dontZoom=!1;var a=this;$.subscribe("/PivotViewer/Views/Canvas/Click",function(b){if(a.isActive){for(var c=null,d=null,e=0;e<a.tiles.length;e++){var f=a.tiles[e].Contains(b.x,b.y);f>=0?(d=a.tiles[e],c=a.tiles[e].facetItem.Id):a.tiles[e].Selected(!1)}a.handleSelection(c,d)}}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(b){if(a.isActive&&!(a.selected.length>0))for(var c=0;c<a.tiles.length;c++){var d=a.tiles[c].Contains(b.x,b.y);a.tiles[c].Selected(d>=0?!0:!1)}}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(b){if(a.isActive){if(a.dontZoom)return void(a.dontZoom=!1);var c=a.Scale,d=(a.currentWidth,a.currentHeight,void 0!=b.scale?0:1e3);void 0!=b.scale?b.scale>=1?a.Scale+=b.scale-1:(a.Scale-=b.scale,a.Scale=a.Scale<1?1:a.Scale):void 0!=b.delta&&(a.Scale=0==b.delta?1:a.Scale+b.delta-1),0/0==a.Scale&&(a.Scale=1);var e=(a.width-a.offsetX)*a.Scale,f=(a.height-a.offsetY)*a.Scale;if(e<a.width||1==a.Scale)a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY,a.currentWidth=a.width,a.currentHeight=a.height,a.Scale=1,a.dontZoom=!0,$(".pv-toolbarpanel-zoomslider").slider("option","value",0);else{var g=(b.x-a.currentOffsetX)/c*a.Scale,h=(b.y-a.currentOffsetY)/c*a.Scale;a.currentOffsetX=b.x-g,a.currentOffsetY=b.y-h,a.currentWidth=e,a.currentHeight=f}var i=a.GetRowsAndColumns(a.currentWidth-a.offsetX,a.currentHeight-a.offsetY,a.maxRatio,a.currentFilter.length);if(a.SetVisibleTilePositions(i,a.currentFilter,a.currentOffsetX,a.currentOffsetY,!0,!0,d),1==a.Scale&&1!=c){for(var j=0;j<a.tiles.length;j++)a.tiles[j].Selected(!1);a.selected="",$.publish("/PivotViewer/Views/Item/Selected",[{id:a.selected,bkt:0}])}}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(b){if(a.isActive){var c=b.x,d=b.y,e=!1,f=!1;a.currentOffsetX+=c,a.currentOffsetY+=d,c>0&&a.currentOffsetX>a.offsetX&&(a.currentOffsetX-=c,e=!0),d>0&&a.currentOffsetY>a.offsetY&&(a.currentOffsetY-=d,f=!0),a.currentOffsetX<a.offsetX&&a.currentWidth==a.width&&(a.currentOffsetX-=c,e=!0),0>c&&a.currentOffsetX<-1*(a.currentWidth-a.width)&&(a.currentOffsetX-=c,e=!0),a.currentOffsetY<a.offsetY&&a.currentHeight==a.height&&(a.currentOffsetY-=d,f=!0),0>d&&a.currentOffsetY-a.offsetY<-1*(a.currentHeight-a.height)&&(a.currentOffsetY-=d,f=!0),e&&f||(e?a.OffsetTiles(0,d):f?a.OffsetTiles(c,0):a.OffsetTiles(c,d))}})},Setup:function(a,b,c,d,e){this.width=a,this.height=b,this.offsetX=c,this.offsetY=d,this.maxRatio=e,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},Filter:function(a,b,c,d,e,f){var g=this,h=!1;if(Modernizr.canvas){Debug.Log("Grid View Filtered: "+b.length),this.changingView=!1,e&&($(".pv-tableview-table").is(":visible")&&(h=!0,$(".pv-tableview-table").fadeOut(),this.selected="",$(".pv-toolbarpanel-zoomslider").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","1px"),$(".pv-viewarea-canvas").fadeIn(function(){$.publish("/PivotViewer/Views/ChangeTo/Grid",[{Item:f}])})),$(".pv-mapview-canvas").is(":visible")&&(h=!0,$(".pv-mapview-canvas").fadeOut(),this.selected="",$(".pv-toolbarpanel-zoomslider").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","1px"),$(".pv-viewarea-canvas").fadeIn(function(){$.publish("/PivotViewer/Views/ChangeTo/Grid",[{Item:f}])})),$(".pv-timeview-canvas").is(":visible")&&(h=!0,$(".pv-timeview-canvas").fadeOut(),this.selected="",$(".pv-toolbarpanel-timelineselector").fadeOut(),$(".pv-toolbarpanel-sort").fadeIn(),$(".pv-toolbarpanel-zoomslider").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","1px"),$("#MAIN_BODY").css("overflow","auto"),$(".pv-viewarea-canvas").fadeIn(function(){$.publish("/PivotViewer/Views/ChangeTo/Grid",[{Item:f}])
}))),this.tiles=a,this.init&&this.SetInitialTiles(this.tiles,this.width,this.height);for(var i=0;i<this.tiles.length;i++)for(;this.tiles[i]._locations.length>1;)this.tiles[i]._locations.pop();for(var j=0;j<this.tiles.length;j++)this.tiles[j].selectedLoc=0;if(this.tiles=this.tiles.sort(this.SortBy(c,!1,function(a){return $.isNumeric(a)?a:a.toUpperCase()},d)),this.currentFilter=b,!h||""==f){var k=0;Debug.Log("this.currentWidth: "+this.currentWidth+" this.width: "+this.width);var l=$(".pv-toolbarpanel-zoomslider").slider("option","value");if(l>0){this.selected=selectedItem="",this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-toolbarpanel-zoomslider").slider("option","value",1);for(var m=this.GetRowsAndColumns(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.tiles.length),n=[],j=0;j<this.tiles.length;j++)this.tiles[j].origwidth=m.TileHeight/this.tiles[j]._controller.GetRatio(this.tiles[j].facetItem.Img),this.tiles[j].origheight=m.TileHeight,n.push(this.tiles[j].facetItem.Id);this.SetVisibleTilePositions(m,n,this.currentOffsetX,this.currentOffsetY,!0,!1,1e3),k=1e3}setTimeout(function(){for(var a=0;a<g.tiles.length;a++){g.tiles[a]._locations[0].startx=g.tiles[a]._locations[0].x,g.tiles[a]._locations[0].starty=g.tiles[a]._locations[0].y,g.tiles[a].startwidth=g.tiles[a].width,g.tiles[a].startheight=g.tiles[a].height;var c=$.inArray(g.tiles[a].facetItem.Id,b);0>c&&(g.SetOuterTileDestination(g.width,g.height,g.tiles[a]),g.tiles[a].start=PivotViewer.Utils.Now(),g.tiles[a].end=g.tiles[a].start+1e3)}g.maxRatio=g.tiles[0]._controller.GetRatio(g.tiles[0].facetItem.Img);for(var a=0;a<g.tiles.length;a++){var c=$.inArray(g.tiles[a].facetItem.Id,b);c>=0&&g.tiles[a]._controller.GetRatio(g.tiles[a].facetItem.Img)<g.maxRatio&&(g.maxRatio=g.tiles[a]._controller.GetRatio(g.tiles[a].facetItem.Img))}var d=b.length==g.tiles.length?0:500;setTimeout(function(){for(var a=g.GetRowsAndColumns(g.width-g.offsetX,g.height-g.offsetY,g.maxRatio,g.currentFilter.length),b=0;b<g.tiles.length;b++)g.tiles[b].origwidth=a.TileHeight/g.tiles[b]._controller.GetRatio(g.tiles[b].facetItem.Img),g.tiles[b].origheight=a.TileHeight;g.SetVisibleTilePositions(a,g.currentFilter,g.offsetX,g.offsetY,!1,!1,1e3)},d)},k)}this.init=!1}},GetUI:function(){return Modernizr.canvas?"":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"images/GridView.png"},GetButtonImageSelected:function(){return"images/GridViewSelected.png"},GetViewName:function(){return"Grid View"},SetVisibleTilePositions:function(a,b,c,d,e,f,g){var h=f&&this.rowscols?this.rowscols.Columns:a.Columns;f||(this.rowscols=a);for(var i=0,j=0,k=0;k<this.tiles.length;k++){var l=$.inArray(this.tiles[k].facetItem.Id,b);l>=0&&(e&&(this.tiles[k]._locations[0].startx=this.tiles[k]._locations[0].x,this.tiles[k]._locations[0].starty=this.tiles[k]._locations[0].y,this.tiles[k].startwidth=this.tiles[k].width,this.tiles[k].startheight=this.tiles[k].height),this.tiles[k].destinationwidth=a.TileMaxWidth,this.tiles[k].destinationheight=a.TileHeight,this.tiles[k]._locations[0].destinationx=i*a.TileMaxWidth+c,this.tiles[k]._locations[0].destinationy=j*a.TileHeight+d,this.tiles[k].start=PivotViewer.Utils.Now(),this.tiles[k].end=this.tiles[k].start+g,i==h-1?(i=0,j++):i++)}},GetSelectedCol:function(a){var b=this;return selectedCol=Math.round((a._locations[0].x-b.currentOffsetX)/a.width)},GetSelectedRow:function(a){var b=this;return selectedRow=Math.round((a._locations[0].y-b.currentOffsetY)/a.height)},CentreOnSelectedTile:function(a,b){for(var c,d=this,e=0;e<d.tiles.length;e++)if(d.tiles[e].IsSelected()){c=d.tiles[e];break}var f=d.GetRowsAndColumns(d.currentWidth-d.offsetX,d.currentHeight-d.offsetY,d.maxRatio,d.currentFilter.length);d.currentOffsetX=f.TileMaxWidth*a*-1+d.width/2-f.TileMaxWidth/2,d.currentOffsetY=f.TileHeight*b*-1+d.height/2-f.TileHeight/2,d.SetVisibleTilePositions(f,d.currentFilter,d.currentOffsetX,d.currentOffsetY,!0,!0,1e3)},handleSelection:function(a,b){var c=this,d=0,e=0;if(null!=a&&null!=b&&(d=Math.round((b._locations[0].x-c.currentOffsetX)/b.width),e=Math.round((b._locations[0].y-c.currentOffsetY)/b.height)),null!=a&&c.selected!=a&&""==c.selected){var f=$(".pv-toolbarpanel-zoomslider").slider("option","value");0!=f&&$(".pv-toolbarpanel-zoomslider").slider("option","value",0)}if(null!=a&&null!=b&&(b.Selected(!0),tileHeight=b.height,tileWidth=b.height/b._controller.GetRatio(b.facetItem.Img),tileOrigHeight=b.origheight,tileOrigWidth=b.origwidth,canvasHeight=b.context.canvas.height,canvasWidth=b.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width())),null!=a&&c.selected!=a){if(origProportion=tileHeight/canvasHeight>tileWidth/canvasWidth?tileOrigHeight/canvasHeight:tileOrigWidth/canvasWidth,scale=Math.round(.75/origProportion*2),""==c.selected){var f=$(".pv-toolbarpanel-zoomslider").slider("option","value");f=scale,$(".pv-toolbarpanel-zoomslider").slider("option","value",f)}c.selected=a,c.CentreOnSelectedTile(d,e)}else{c.selected=a="",c.currentOffsetX=c.offsetX,c.currentOffsetY=c.offsetY;var f=$(".pv-toolbarpanel-zoomslider").slider("option","value");f=0,$(".pv-toolbarpanel-zoomslider").slider("option","value",f)}$.publish("/PivotViewer/Views/Item/Selected",[{id:a,bkt:0}])}}),PivotViewer.Views.IImageController=Object.subClass({init:function(){},Setup:function(){},GetImagesAtLevel:function(){},Width:0,Height:0}),PivotViewer.Views.LoadImageSetHelper=Object.subClass({init:function(){this._images=[],this._loaded=!1},LoadImages:function(a){for(var b=this,c=0;c<a.length;c++){var d=new Image;d.src=a[c],d.onload=function(){b._loaded=!0},this._images.push(d)}},GetImages:function(){return this._images},IsLoaded:function(){return this._loaded}}),PivotViewer.Views.TableView=PivotViewer.Views.IPivotViewerView.subClass({init:function(){this._super()},Setup:function(a,b,c,d){this.width=a,this.height=b,this.offsetX=c,this.offsetY=d,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,$(".pv-viewpanel").append("<div style='visibility:hidden;position:relative;' id='pv-table-loader'><img src='images/loading.gif'></img></div>"),$("#pv-table-loader").css("top",this.height/2-33+"px"),$("#pv-table-loader").css("left",this.width/2-43+"px")},Filter:function(a,b,c,d,e,f){Modernizr.canvas&&(Debug.Log("Table View Filtered: "+b.length),e&&($(".pv-viewarea-canvas").fadeOut(),$(".pv-mapview-canvas").fadeOut(),$(".pv-timeview-canvas").fadeOut(),$(".pv-toolbarpanel-sort").fadeIn(),$(".pv-toolbarpanel-timelineselector").fadeOut(),$(".pv-toolbarpanel-zoomslider").fadeOut(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","0"),$("#MAIN_BODY").css("overflow","auto"),$(".pv-tableview-table").fadeIn(function(){f&&$.publish("/PivotViewer/Views/Item/Selected",[{id:f.Id,bkt:0}])})),this.tiles=a,this.currentFilter=b,this.selectedId="",this.sortReverseEntity=!0,this.sortReverseAttribute=!0,this.sortReverseValue=!0,this.CreateTable(b,this.selectedFacet),this.init=!1)},GetUI:function(){return Modernizr.canvas?"":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"images/TableView.png"},GetButtonImageSelected:function(){return"images/TableViewSelected.png"},GetViewName:function(){return"Table View"},CellClick:function(a,b){if(Debug.Log("CellClick"),"pv-key"==a){for(var c=b[0].textContent.trim(),d=-1,e=0;e<this.tiles.length;e++)if(this.tiles[e].facetItem.Name==c){d=this.tiles[e].facetItem.Id;break}d>=0&&d!=this.selectedId?(this.selectedId=d,$.publish("/PivotViewer/Views/Item/Selected",[{id:d,bkt:0}])):d>=0&&d==this.selectedId&&(this.selectedId="",$.publish("/PivotViewer/Views/Item/Selected",[{id:"",bkt:0}]))}else if("pv-facet"==a){var f=[];""==this.selectedId||null==this.selectedId?f=this.currentFilter:f[0]=this.selectedId,""==this.selectedFacet||null==this.selectedFacet?(this.selectedFacet=b[1].textContent.trim(),this.CreateTable(f,this.selectedFacet,this.sortKey)):(this.selectedFacet="",this.CreateTable(f,"")),$.publish("/PivotViewer/Views/Item/Updated",null)}else"pv-value"==a&&$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:b[1].textContent.trim(),Item:b[2].textContent.trim(),Values:null,ClearFacetFilters:!0}])},CreateTable:function(a,b,c,d){var e=this,f=$("#pv-table"),g=!1,h=new Array;f.empty();var i,j;(null==b||""==b||void 0==typeof b)&&(g=!0),$(".pv-tableview-table").css("height",this.height-12+"px"),$(".pv-tableview-table").css("width",this.width-415+"px"),i=d?"images/sort-up.png":"images/sort-down.png";var m="odd-row",n="<table id='pv-table-data' style='color:#484848;'><tr class='pv-tableview-heading'><th id='pv-key' class='tooltipcustom' title='Sort on item name'>Item";"pv-key"==c&&(n+=" <img style='position:relative;top:"+j+"' src='"+i+"'></img>"),n+="</th><th class='tooltipcustom' id='pv-facet' title='Sort on relation name'>Relation","pv-facet"==c&&(n+=" <img style='position:relative;top:"+j+"' src='"+i+"'></img>"),n+="</th><th id='pv-value' class='tooltipcustom' title='Sort on value'>Value","pv-value"==c&&(n+=" <img style='position:relative;top:"+j+"' src='"+i+"'></img>"),n+="</th></tr>";for(var o=0;o<a.length;o++)for(var p=0;p<this.tiles.length;p++)if(this.tiles[p].facetItem.Id==a[o]){var q=this.tiles[p].facetItem.Name;if(g||"Description"==b){var r;"pv-key"==c?r=q:"pv-facet"==c?r="Description":"pv-value"==c&&(r=this.tiles[p].facetItem.Description),this.tiles[p].facetItem.Description&&(h.push(this.tiles[p].facetItem.Href?{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+q+" <a href="+this.tiles[p].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' title='Follow the link' src='images/goout.gif'></img></a></a></td><td id='pv-facet' class='tooltipcustom' title='Show only this relation' style='color:#009933;cursor:pointer'>Description</td><td id='pv-value'>"+this.tiles[p].facetItem.Description+"</td></tr>"}:{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltip' title='Toggle item selection'>"+q+"</td><td id='pv-facet' class='tooltipcustom' title='Show only this relation' style='color:#009933;cursor:pointer'>Description</td><td id='pv-value'>"+this.tiles[p].facetItem.Description+"</td></tr>"}),m="even-row")}if(m="odd-row"==m?"even-row":"odd-row",g)for(k=0;k<this.tiles[p].facetItem.Facets.length;k++){var s=this.tiles[p].facetItem.Facets[k].Name;for(l=0;l<this.tiles[p].facetItem.Facets[k].FacetValues.length;l++){var r,t=this.tiles[p].facetItem.Facets[k].FacetValues[l].Value;"pv-key"==c?r=q:"pv-facet"==c?r=s:"pv-value"==c&&(r=t),h.push(this.IsFilterVisible(s)?this.tiles[p].facetItem.Href?this.IsUri(t)?{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+q+" <a href="+this.tiles[p].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom'  title='Show only this relation' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+t+" <a href="+t+" target=\"_blank\"><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td></tr>"}:{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+q+" <a href="+this.tiles[p].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom'  title='Show only this relation' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+t+"</td></tr>"}:this.IsUri(t)?{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+q+"</td><td id='pv-facet' class='tooltipcustom'  title='Show only this relation' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+t+" <a href="+t+" target=\"_blank\"><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td></tr>"}:{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+q+"</td><td id='pv-facet' class='tooltipcustom'  title='Show only this relation' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value' class='tooltipinter'  title='Filter on this value' style='color:#009933;cursor:pointer'>"+t+"</td></tr>"}:this.tiles[p].facetItem.Href?this.IsUri(t)?{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+q+" <a href="+this.tiles[p].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Show only this relation' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value'><a href="+t+">"+t+"</a></td></tr>"}:{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+q+" <a href="+this.tiles[p].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Show only this relation' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value'>"+t+"</td></tr>"}:this.IsUri(t)?{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipcustom' title='Select this value'>"+q+"</td><td id='pv-facet' class='tooltipcustom' title='Show only this relation' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value'><a href"+t+">"+t+"</a></td></tr>"}:{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipcustom' title='Select this value'>"+q+"</td><td id='pv-facet' class='tooltipcustom' title='Show only this relation' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value'>"+t+"</td></tr>"}),m="odd-row"==m?"even-row":"odd-row"}}else for(k=0;k<this.tiles[p].facetItem.Facets.length;k++){var s=this.tiles[p].facetItem.Facets[k].Name;if(s==b){for(l=0;l<this.tiles[p].facetItem.Facets[k].FacetValues.length;l++){var r,t=this.tiles[p].facetItem.Facets[k].FacetValues[l].Value;"pv-key"==c?r=q:"pv-facet"==c?r=s:"pv-value"==c&&(r=t),h.push(this.IsFilterVisible(s)?this.tiles[p].facetItem.Href?this.IsUri(t)?{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+q+" <a href="+this.tiles[p].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value' class='tooltipinter 'title='Filter on this value' style='color:#009933;cursor:pointer'>"+t+" <a href="+t+" target=\"_blank\"><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td></tr>"}:{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipinter' title='Toggle item selection' style='color:#009933;cursor:pointer'>"+q+" <a href="+this.tiles[p].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+t+"</td></tr>"}:this.IsUri(t)?{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+q+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+t+" <a href="+t+" target=\"_blank\"><img style='cursor:default;' id=pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td></tr>"}:{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+q+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value' class='tooltipinter' title='Filter on this value' style='color:#009933;cursor:pointer'>"+t+"</td></tr>"}:this.tiles[p].facetItem.Href?this.IsUri(t)?{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipinter' title='Click the cell to select this item' style='color:#009933;cursor:pointer'>"+q+" <a href="+this.tiles[p].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value'><a href="+t+">"+t+"</a></td></tr>"}:{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipinter' title='Click the cell to select this item' style='color:#009933;cursor:pointer'>"+q+" <a href="+this.tiles[p].facetItem.Href.replace(/'/g,"%27")+" target=\"_blank\"><img style='cursor:default;' id='pv-linkout' title='Follow the link' src='images/goout.gif'></img></a></td><td id='pv-facet' class='tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value'>"+t+"</td></tr>"}:this.IsUri(t)?{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+q+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value'><a href"+t+">"+t+"</a></td></tr>"}:{key:r,value:"<tr class='pv-tableview-"+m+"'><td id='pv-key' class='tooltipcustom' title='Toggle item selection'>"+q+"</td><td id='pv-facet' class-'tooltipcustom' title='Clear relation selection' style='color:#009933;cursor:pointer'>"+s+"</td><td id='pv-value'>"+t+"</td></tr>"}),m="odd-row"==m?"even-row":"odd-row"}break}}}if(0==h.length){if(1==g){var u="";u+="There is not data to show about the selected items",$(".pv-wrapper").append('<div id="pv-dztable-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+u+"</p></div></div>");{setTimeout(function(){window.open("#pv-dztable-error","_self")},1e3)}return}this.CreateTable(a,"",c,d)}else{h.sort(function(a,b){return a.key>b.key?1:a.key<b.key?-1:0}),d&&h.reverse();for(var o=0;o<h.length;o++)n+=h[o].value;n+="</table>",f.append(n),$("#pv-table-data").colResizable({disable:!0}),$("#pv-table-data").colResizable({disable:!1}),$(".pv-tableview-heading").on("click",function(a){$("#pv-table-loader").show();var b=a.originalEvent.target.id,c=[];$(".tooltipinter").tooltipster("hide"),$(".tooltipcustom").tooltipster("hide"),""==e.selectedId||null==e.selectedId?c=e.currentFilter:c[0]=e.selectedId;var d;"pv-key"==b?(d=e.sortReverseEntity?!1:!0,e.sortReverseEntity=d):"pv-facet"==b?(d=e.sortReverseAttribute?!1:!0,e.sortReverseAttribute=d):"pv-value"==b&&(d=e.sortReverseValue?!1:!0,e.sortReverseValue=d),e.sortKey=b,e.CreateTable(c,e.selectedFacet,b,d),$("#pv-table-loader").fadeOut()}),$(".pv-tableview-odd-row").on("click",function(a){$("#pv-table-loader").show(),$(".tooltipinter").tooltipster("hide"),$(".tooltipcustom").tooltipster("hide");var b=a.originalEvent.target.id;e.CellClick(b,a.currentTarget.cells),$("#pv-table-loader").fadeOut()}),$(".pv-tableview-even-row").on("click",function(a){$("#pv-table-loader").show(),$(".tooltipinter").tooltipster("hide"),$(".tooltipcustom").tooltipster("hide");var b=a.originalEvent.target.id;e.CellClick(b,a.currentTarget.cells),$("#pv-table-loader").fadeOut()})}},Selected:function(a){var b=[];""==a||null==a||void 0==typeof a?(this.selectedId="",this.CreateTable(this.currentFilter,this.selectedFacet)):(b[0]=a,this.selectedId=a,this.CreateTable(b,this.selectedFacet))},SetFacetCategories:function(a){this.categories=a.FacetCategories},IsFilterVisible:function(a){var b=null;for(i=0;i<this.categories.length;i++)this.categories[i].Name==a&&(b=this.categories[i].IsFilterVisible);return null!=b?b:!1},IsUri:function(a){var b=a,c=!1;return"string"==typeof a&&("http:"==b.substring(0,5)&&(c=!0),"https:"==b.substring(0,6)&&(c=!0)),c},SetSelectedFacet:function(a){this.selectedFacet=a},GetSelectedFacet:function(){return this.selectedFacet}}),PivotViewer.Views.TileController=Object.subClass({init:function(a){this._tiles=[],this._helpers=[],this._helperText="",this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=a},initTiles:function(a,b,c){for(var d=0;d<a.length;d++){var e=new PivotViewer.Views.Tile(this._imageController);e.facetItem=a[d],e.CollectionRoot=b.replace(/\\/gi,"/").replace(/\.xml/gi,""),this._canvasContext=c,e.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,e._locations.push(tileLocation),this._tiles.push(e)}return this._tiles},AnimateTiles:function(a,b){var c=this;this._started=!0;var d=null,e=!1;if(this._tiles.length>0&&null!=this._tiles[0].context){d=this._tiles[0].context;for(var f=!1,g=0;g<this._tiles.length;g++)for(k=0;k<this._tiles[g]._locations.length;k++){var h=PivotViewer.Utils.Now()-this._tiles[g].start,i=this._tiles[g].end-this._tiles[g].start;if(i>=h)(this._tiles[g]._locations[k].x!=this._tiles[g]._locations[k].destinationx||this._tiles[g]._locations[k].y!=this._tiles[g]._locations[k].destinationy)&&(f=!0),this._tiles[g]._locations[k].x=this._easing.ease(h,this._tiles[g]._locations[k].startx,this._tiles[g]._locations[k].destinationx-this._tiles[g]._locations[k].startx,i),this._tiles[g]._locations[k].y=this._easing.ease(h,this._tiles[g]._locations[k].starty,this._tiles[g]._locations[k].destinationy-this._tiles[g]._locations[k].starty,i),(this._tiles[g].width!=this._tiles[g].destinationWidth||this._tiles[g].height!=this._tiles[g].destinationHeight)&&(f=!0),this._tiles[g].width=this._easing.ease(h,this._tiles[g].startwidth,this._tiles[g].destinationwidth-this._tiles[g].startwidth,i),this._tiles[g].height=this._easing.ease(h,this._tiles[g].startheight,this._tiles[g].destinationheight-this._tiles[g].startheight,i);else if(this._tiles[g]._locations[k].x=this._tiles[g]._locations[k].destinationx,this._tiles[g]._locations[k].y=this._tiles[g]._locations[k].destinationy,this._tiles[g].width=this._tiles[g].destinationwidth,this._tiles[g].height=this._tiles[g].destinationheight,!isNaN(h)&&!isNaN(i)&&a){var j="";for(t=0;t<this._tiles.length;t++)if(this._tiles[t].facetItem.Id==b){j=this._tiles[t];break}b&&j&&$.publish("/PivotViewer/Views/Canvas/Click",[{x:j._locations[j.selectedLoc].destinationx,y:j._locations[j.selectedLoc].destinationy}]),a=!1,b=0}this._tiles[g].destinationVisible=this._tiles[g]._locations[k].destinationx+this._tiles[g].destinationwidth<0||this._tiles[g]._locations[k].destinationx>d.canvas.width||this._tiles[g]._locations[k].destinationy+this._tiles[g].destinationheight<0||this._tiles[g]._locations[k].destinationy>d.canvas.height?!1:!0}}this._isZooming!=f&&(this._isZooming=f,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),d.clearRect(0,0,d.canvas.width,d.canvas.height);for(var g=0;g<this._tiles.length;g++)for(var k=0;k<this._tiles[g]._locations.length;k++)this._tiles[g]._locations[k].x+this._tiles[g].width>0&&this._tiles[g]._locations[k].x<d.canvas.width&&this._tiles[g]._locations[k].y+this._tiles[g].height>0&&this._tiles[g]._locations[k].y<d.canvas.height&&(e?this._tiles[g].DrawEmpty(k):this._tiles[g].Draw(k));return this._breaks?void(this._started=!1):void requestAnimFrame(function(){c.AnimateTiles(a,b)})},BeginAnimation:function(a,b){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.AnimateTiles(a,b))},StopAnimation:function(){this._breaks=!0},SetLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},SetCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},SetQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},GetMaxTileRatio:function(){return this._imageController.MaxRatio},DrawHelpers:function(a){this._helpers=a},DrawHelperText:function(a){this._helperText=a}}),PivotViewer.Views.Tile=Object.subClass({init:function(a){return this instanceof PivotViewer.Views.Tile?(this._controller=a,this._imageLoaded=!1,this._selected=!1,this._level=0,this._images=null,void(this._locations=[])):new PivotViewer.Views.Tile(a)},IsSelected:function(){return this._selected},Draw:function(a){if(this.destinationVisible){var b=this.width>this.height?this.width:this.height,c=Math.ceil(Math.log(b)/Math.log(2));(1/0==c||c==-1/0)&&(c=0),this._level=c,this._images=this._controller.GetImagesAtLevel(this.facetItem.Img,this._level)}if(null!=this._images){if("function"==typeof this._images)this._images(this.facetItem,this.context,this._locations[a].x+4,this._locations[a].y+4,this.width-8,this.height-8);else if(this._images.length>0&&this._images[0]instanceof Image){var d=this._controller.GetHeight(this.facetItem.Img),e=this.height-8,f=Math.ceil(this._controller.GetWidthForImage(this.facetItem.Img,e));blankWidth=this.width-8-f;for(var g=0;g<this._images.length;g++){var h=this._images[g].src,i=this._controller._tileSize,j=h.match(/[0-9]+_[0-9]+/g),k=parseInt(j[j.length-1].substring(0,j[j.length-1].indexOf("_"))),l=parseInt(j[j.length-1].substring(j[j.length-1].indexOf("_")+1));j=h.match(/_files\/[0-9]+\//g);var m=parseInt(j[0].substring(7,j[0].length-1)),n=Math.ceil(d/Math.pow(2,this._controller.GetMaxLevel(this.facetItem.Img)-m)),o=e/n;overlap=this._controller.GetOverlap(this.facetItem.Img);var p=Math.floor(blankWidth/2)+4+k*Math.floor((i-overlap)*o),q=4+Math.floor(l*(i-overlap)*o),r=Math.ceil(this._images[g].height*o),s=Math.ceil(this._images[g].width*o);this.context.drawImage(this._images[g],p+this._locations[a].x,q+this._locations[a].y,s,r)}if(this._selected){this.context.beginPath();var p=Math.floor(blankWidth/2)+4,q=4;this.context.rect(p+this._locations[this.selectedLoc].x,q+this._locations[this.selectedLoc].y,f,e),this.context.lineWidth=4,this.context.strokeStyle="#92C4E1",this.context.stroke()}}}else this.DrawEmpty(a)},Contains:function(a,b){var c=!1,d=-1;for(i=0;i<this._locations.length;i++)c=this._locations[i].x<=a&&this._locations[i].x+this.width>=a&&this._locations[i].y<=b&&this._locations[i].y+this.height>=b,c&&(d=i);return d},DrawEmpty:function(a){void 0==this._controller.DrawLevel?(this.context.beginPath(),this.context.fillStyle="#D7DDDD",this.context.fillRect(this._locations[a].x+4,this._locations[a].y+4,this.width-8,this.height-8),this.context.rect(this._locations[a].x+4,this._locations[a].y+4,this.width-8,this.height-8),this.context.lineWidth=1,this.context.strokeStyle="white",this.context.stroke()):this._controller.DrawLevel(this.facetItem,this.context,this._locations[a].x+4,this._locations[a].y+4,this.width-8,this.height-8)},CollectionRoot:"",now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,facetItem:null,firstFilterItemDone:!1,selectedLoc:0,Selected:function(a){this._selected=a}}),PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0}),PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[],this._collageItems=[],this._baseUrl="",this._collageMaxLevel=0,this._tileSize=256,this._format="",this._ratio=1,this.MaxRatio=1,this._zooming=!1;var a=this;$.subscribe("/PivotViewer/ImageController/Zoom",function(b){a._zooming=b})},Setup:function(a){this._baseUrl=a.substring(0,a.lastIndexOf("/")),this._collageUrl=a.substring(a.lastIndexOf("/")+1).replace(".xml","_files");var b=this;$.ajax({type:"GET",url:a,dataType:"xml",success:function(a){var c=$(a).find("Collection");b._tileSize=$(c).attr("TileSize"),b._format=$(c).attr("Format"),b._collageMaxLevel=$(c).attr("MaxLevel");var d=$(a).find("I");if(0!=d.length){var e=$(d[0]).find("Size");if(e.length>0)for(b.MaxWidth=parseInt(e.attr("Width")),b.Height=parseInt(e.attr("Height")),b.MaxRatio=b.Height/b.MaxWidth,i=0;i<d.length;i++){itemSize=$(d[i]).find("Size");var f=parseInt(itemSize.attr("Width")),g=parseInt(itemSize.attr("Height")),h=f>g?f:g,j=Math.ceil(Math.log(h)/Math.log(2));b._ratio=g/f;var k=$(d[i]).attr("Source"),l=$(d[i]).attr("Id"),m=$(d[i]).attr("N"),n=k.substring(k.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),o=k.substring(0,k.lastIndexOf("/"));o.length>0&&(o+="/"),f>b.MaxWidth&&(b.MaxWidth=f),b._ratio<b.MaxRatio&&(b.MaxRatio=b._ratio),b._items.push(new PivotViewer.Views.DeepZoomItem(l,n,m,o,b._ratio,f,g,j,b._baseUrl,k))}$.publish("/PivotViewer/ImageController/Collection/Loaded",null)}else{$(".pv-loading").remove();var p="";p+="No items in the DeepZoom Collection<br><br>",p=p+"URL        : "+this.url+"<br>",p+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+p+"</p></div></div>");{setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}}},error:function(a,b,c){$(".pv-loading").remove();var d="";d+="Error loading from DeepZoom Cache<br><br>",d=d+"URL        : "+this.url+"<br>",d=d+"Status : "+a.status+" "+c+"<br>",d=d+"Details    : "+a.responseText+"<br>",d+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+d+"</p></div></div>");setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}})},GetImagesAtLevel:function(a,b){b=0>=b?6:b;for(var c=0;c<this._items.length;c++)if(this._items[c].ItemId==a){b=b>this._items[c].MaxLevel?this._items[c].MaxLevel:b;for(var d=this._items[c].DZN.toString(2),e="",f="",g=0;g<d.length;g++)g%2==0?e+=d[g]:f+=d[g];if(dzCol=parseInt(e,2),dzRow=parseInt(f,2),!(void 0!=this._items[c].Levels&&0!=this._items[c].Levels.length||this._zooming)){var h=this.GetImageList(c,this._baseUrl+"/"+this._items[c].BasePath+this._items[c].DZId+"_files/6/",6),i=new PivotViewer.Views.LoadImageSetHelper;return i.LoadImages(h),this._items[c].Levels.push(i),null
}if(this._items[c].Levels.length<b&&!this._zooming){var h=this.GetImageList(c,this._baseUrl+"/"+this._items[c].BasePath+this._items[c].DZId+"_files/"+b+"/",b),i=new PivotViewer.Views.LoadImageSetHelper;i.LoadImages(h),this._items[c].Levels.splice(b,0,i)}for(var j=b;j>-1;j--){if(void 0!=this._items[c].Levels[j]&&this._items[c].Levels[j].IsLoaded())return this._items[c].Levels[j].GetImages();if(j==b&&void 0==this._items[c].Levels[j]&&!this._zooming){var h=this.GetImageList(c,this._baseUrl+"/"+this._items[c].BasePath+this._items[c].DZId+"_files/"+j+"/",j),i=new PivotViewer.Views.LoadImageSetHelper;i.LoadImages(h),this._items[c].Levels.splice(j,0,i)}}return null}return null},GetImageList:function(a,b,c){for(var d=[],e=this._tileSize,f=this._format,g=this._items[a].Ratio,h=this._items[a].Height,i=this._items[a].MaxLevel,j=Math.ceil(h/g/Math.pow(2,i-c)),k=Math.ceil(h/Math.pow(2,i-c)),l=Math.ceil(j/e),m=Math.ceil(k/e),n=0;l>n;n++)for(var o=0;m>o;o++)d.push(b+n+"_"+o+"."+f);return d},GetWidthForImage:function(a,b){for(var c=0;c<this._items.length;c++)if(this._items[c].ItemId==a)return Math.floor(b/this._items[c].Ratio)},GetDzi:function(a){for(var b=0;b<this._items.length;b++)if(this._items[b].ItemId==a)return dziName=this._baseUrl+"/"+this._items[b].BasePath+this._items[b].DZId+".dzi"},GetMaxLevel:function(a){for(var b=0;b<this._items.length;b++)if(this._items[b].ItemId==a)return this._items[b].MaxLevel},GetWidth:function(a){for(var b=0;b<this._items.length;b++)if(this._items[b].ItemId==a)return this._items[b].Width},GetHeight:function(a){for(var b=0;b<this._items.length;b++)if(this._items[b].ItemId==a)return this._items[b].Height},GetOverlap:function(a){for(var b=0;b<this._items.length;b++)if(this._items[b].ItemId==a)return this._items[b].Overlap},GetRatio:function(a){for(var b=0;b<this._items.length;b++)if(this._items[b].ItemId==a)return this._items[b].Ratio}}),PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(a,b,c,d,e,f,g,h,i,j){this.ItemId=a,this.DZId=b,this.DZN=parseInt(c),this.BasePath=d,this.Levels=[],this.Ratio=e,this.Width=f,this.Height=g,this.MaxLevel=h;var k=this;$.ajax({type:"GET",url:i+"/"+j,dataType:"xml",success:function(a){var b=$(a).find("Image");if(0!=b.length){var c=$(b[0]);k.Overlap=c.attr("Overlap")}},complete:function(){},error:function(){k.Overlap=0}})}}),function(a){var b,c,d,e=[],f=[],g=[],h=[],k=[],m=[],n=[],o=0,p=[],q=[],r="",s=0,u="",v="",w=!1,x="",y=null,z=null,A={View:null,Facet:null,Filters:[]},B=null,C={},D=!1,E=new PivotViewer.Models.Collection,F={init:function(a){if(B=this,B.addClass("pv-wrapper"),InitPreloader(),void 0==a.Loader)throw"Collection loader is undefined.";if(!(a.Loader instanceof PivotViewer.Models.Loaders.ICollectionLoader))throw"Collection loader does not inherit from PivotViewer.Models.Loaders.ICollectionLoader.";if(a.Loader.LoadCollection(E),void 0==a.ImageController)c=new PivotViewer.Views.DeepZoomImageController;else{if(!a.ImageController instanceof PivotViewer.Views.IImageController)throw"Image Controller does not inherit from PivotViewer.Views.IImageController.";c=a.ImageController}if(void 0!=a.GoogleAPIKey&&(d=a.GoogleAPIKey),void 0!=a.ViewerState)for(var b=a.ViewerState.split("&"),e=0,f=b.length;f>e;e++){var g=b[e].split("=");if(2==g.length)if("$view$"==g[0])A.View=parseInt(g[1])-1;else if("$facet0$"==g[0])A.Facet=PivotViewer.Utils.EscapeItemId(g[1]);else if("$selection$"==g[0])A.Selection=PivotViewer.Utils.EscapeItemId(g[1]);else if("$tableFacet$"==g[0])A.TableFacet=PivotViewer.Utils.EscapeItemId(g[1]);else if("$mapCentreX$"==g[0])A.MapCentreX=g[1];else if("$mapCentreY$"==g[0])A.MapCentreY=g[1];else if("$mapType$"==g[0])A.MapType=PivotViewer.Utils.EscapeItemId(g[1]);else if("$mapZoom$"==g[0])A.MapZoom=PivotViewer.Utils.EscapeItemId(g[1]);else if("$timelineFacet$"==g[0])A.TimelineFacet=PivotViewer.Utils.EscapeItemId(g[1]);else{for(var h={Facet:g[0],Predicates:[]},i=g[1].split("_"),j=0,k=i.length;k>j;j++)if(i[j].indexOf(".")>0){var l=i[j].substring(0,i[j].indexOf(".")),m=i[j].substring(i[j].indexOf(".")+1);h.Predicates.push({Operator:l,Value:m})}A.Filters.push(h)}}},show:function(){Debug.Log("Show")},hide:function(){Debug.Log("Hide")}};InitPreloader=function(){B.append("<div class='pv-loading'><img src='images/loading.gif' alt='Loading' /><span>Loading...</span></div>"),a(".pv-loading").css("top",a(".pv-wrapper").height()/2-33+"px"),a(".pv-loading").css("left",a(".pv-wrapper").width()/2-43+"px")},InitTileCollection=function(){InitUI();var d=E.ImageBase;d.indexOf("http",0)>=0||d.indexOf("www.",0)>=0||(d=E.CXMLBase.substring(0,E.CXMLBase.lastIndexOf("/")+1)+d);var e=a(".pv-viewarea-canvas")[0].getContext("2d");b=new PivotViewer.Views.TileController(c),p=b.initTiles(E.Items,d,e),c.Setup(d.replace("\\","/"))},InitPivotViewer=function(){CreateFacetList(),CreateViews(),AttachEventHandlers(),a(".pv-loading").remove(),ApplyViewerState(),u=GetItem(A.Selection),v=A.TableFacet;var c=a(".pv-toolbarpanel").innerWidth()-(a(".pv-toolbarpanel-brandimage").outerWidth(!0)+25+a(".pv-toolbarpanel-name").outerWidth(!0)+a(".pv-toolbarpanel-zoomcontrols").outerWidth(!0)+145+a(".pv-toolbarpanel-sortcontrols").outerWidth(!0));c-=30,a(".pv-toolbarpanel-facetbreadcrumb").css("width",c+"px"),null!=A.View?(0!=A.View&&1!=A.View&&(SelectView(0,!0),w=!1),SelectView(A.View,!0)):SelectView(0,!0);var d=u&&u.Id?u.Id:"";b.BeginAnimation(!0,d),3==o&&(u?(a.publish("/PivotViewer/Views/Item/Selected",[{id:u.Id,bkt:0}]),e[3].RedrawMarkers(u.Id)):(a.publish("/PivotViewer/Views/Item/Selected",[{id:"",bkt:0}]),e[3].RedrawMarkers(""))),UpdateItemCount()},InitUI=function(){var b="<div class='pv-toolbarpanel'>",c=E.BrandImage;c.length>0&&(b+="<img class='pv-toolbarpanel-brandimage' src='"+c+"'></img>"),b+="<span class='pv-toolbarpanel-name'>"+E.CollectionName+"</span>",b+="<span class='pv-toolbarpanel-itemcount'></span>",b+="<div class='pv-toolbarpanel-facetbreadcrumb'></div>",b+="<div class='pv-toolbarpanel-zoomcontrols'><div class='pv-toolbarpanel-zoomslider'></div>",b+="<div class='pv-toolbarpanel-timelineselector'></div></div>",b+="<div class='pv-toolbarpanel-viewcontrols'></div>",b+="<div class='pv-toolbarpanel-sortcontrols'></div>",b+="</div>",B.append(b);var d=0;a(".pv-toolbarpanel-zoomslider").slider({max:100,change:function(b,c){var e=c.value-d;centreX=a(".pv-viewarea-canvas").width()/2,centreY=a(".pv-viewarea-canvas").height()/2,a.publish("/PivotViewer/Views/Canvas/Zoom",[{x:centreX,y:centreY,delta:.5*e}]),d=c.value}}),B.append("<div class='pv-mainpanel'></div>");var e=a(".pv-wrapper").height()-a(".pv-toolbarpanel").height()-6;a(".pv-mainpanel").css("height",e+"px"),a(".pv-mainpanel").append("<div class='pv-filterpanel'></div>"),a(".pv-mainpanel").append("<div class='pv-viewpanel'><canvas class='pv-viewarea-canvas' width='"+B.width()+"' height='"+e+"px'></canvas></div>"),a(".pv-mainpanel").append("<div class='pv-infopanel'></div>"),a(".pv-viewpanel").append("<div class='pv-tableview-table' id='pv-table'></div>"),a(".pv-viewpanel").append("<div class='pv-mapview-canvas' id='pv-map-canvas'></div>"),a(".pv-viewpanel").append("<div class='pv-timeview-canvas' id='pv-time-canvas'></div>");var f=a(".pv-filterpanel");f.append("<div class='pv-filterpanel-export' title='Export data'></div>").append("<div class='pv-filterpanel-clearall'>Clear All</div>").append("<input class='pv-filterpanel-search' type='text' placeholder='Search...' /><div class='pv-filterpanel-search-autocomplete'></div>").css("height",e-13+"px"),null!=navigator.userAgent.match(/iPad/i)?a(".pv-filterpanel-search").css("width",f.width()-10+"px"):a(".pv-filterpanel-search").css("width",f.width()-2+"px"),a(".pv-filterpanel-search-autocomplete").css("width",f.width()-8+"px").hide();var g=a(".pv-infopanel");g.css("left",a(".pv-mainpanel").offset().left+a(".pv-mainpanel").width()-205+"px").css("height",e-28+"px"),g.append("<div class='pv-infopanel-controls'></div>"),a(".pv-infopanel-controls").append("<div><div class='pv-infopanel-controls-navleft'></div><div class='pv-infopanel-controls-navleftdisabled'></div><div class='pv-infopanel-controls-navbar'></div><div class='pv-infopanel-controls-navright'></div><div class='pv-infopanel-controls-navrightdisabled'></div></div>"),a(".pv-infopanel-controls-navleftdisabled").hide(),a(".pv-infopanel-controls-navrightdisabled").hide(),g.append("<div class='pv-infopanel-heading'></div>"),g.append("<div class='pv-infopanel-details'></div>"),E.MaxRelatedLinks>0&&g.append("<div class='pv-infopanel-related'></div>"),""!=E.CopyrightName&&g.append("<div class='pv-infopanel-copyright'><a href=\""+E.CopyrightHref+'" target="_blank">'+E.CopyrightName+"</a></div>"),g.hide()},CreateFacetList=function(){for(var b=0;b<E.Items.length;b++)for(var c=E.Items[b],d=0;d<E.FacetCategories.length;d++){for(var e=E.FacetCategories[d],i=!1,j=0,k=c.Facets.length;k>j;j++){var l=c.Facets[j];if(l.Name==e.Name){for(var m=0;m<l.FacetValues.length;m++)if(e.Type==PivotViewer.Models.FacetType.String||e.Type==PivotViewer.Models.FacetType.Link){for(var n=!1,o="pv-facet-item-"+CleanName(l.Name)+"__"+CleanName(l.FacetValues[m].Value),p=f.length-1;p>-1;p-=1)if(f[p].itemId==o){f[p].count+=1,n=!0;break}n||f.push({itemId:o,itemValue:l.FacetValues[m].Value,facet:l.Name,count:1})}else if(e.Type==PivotViewer.Models.FacetType.Number){for(var q=!1,p=0;p<g.length;p++)if(g[p].Facet==c.Facets[j].Name){g[p].Values.push(l.FacetValues[m].Value),q=!0;break}q||g.push({Facet:l.Name,Values:[l.FacetValues[m].Value]})}i=!0}}if(!i){for(var n=!1,o="pv-facet-item-"+CleanName(e.Name)+"__"+CleanName("(no info)"),p=f.length-1;p>-1;p-=1)if(f[p].itemId==o){f[p].count+=1,n=!0;break}n||f.push({itemId:o,itemValue:"(no info)",facet:e.Name,count:1})}if(e.IsWordWheelVisible)for(var j=0,k=c.Facets.length;k>j;j++){var l=c.Facets[j];if(l.Name==e.Name)for(var m=0;m<l.FacetValues.length;m++)e.Type==PivotViewer.Models.FacetType.String&&h.push({Facet:l.Name,Value:l.FacetValues[m].Value})}}CreateDatetimeBuckets();for(var r=["<div class='pv-filterpanel-accordion'>"],s=[],b=0;b<E.FacetCategories.length;b++){var t="inherit";E.FacetCategories[b].IsFilterVisible||(t="none"),r[b+1]="<h3 style='display:"+t+"'><a href='#' title="+E.FacetCategories[b].Name+">",r[b+1]+=E.FacetCategories[b].Name,r[b+1]+="</a><div class='pv-filterpanel-accordion-heading-clear' facetType='"+E.FacetCategories[b].Type+"'>&nbsp;</div></h3>",r[b+1]+="<div style='display:"+t+"' style='height:30%' id='pv-cat-"+CleanName(E.FacetCategories[b].Name)+"'>",E.FacetCategories[b].Type==PivotViewer.Models.FacetType.DateTime?(E.FacetCategories[b].decadeBuckets.length>1?(r[b+1]+=CreateBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].decadeBuckets,E.FacetCategories[b].yearBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].monthBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].dayBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].hourBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].minuteBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].secondBuckets)):E.FacetCategories[b].yearBuckets.length>1?(r[b+1]+=CreateBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].yearBuckets,E.FacetCategories[b].monthBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].decadeBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].dayBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].hourBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].minuteBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].secondBuckets)):E.FacetCategories[b].monthBuckets.length>1?(r[b+1]+=CreateBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].monthBuckets,E.FacetCategories[b].dayBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].decadeBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].yearBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].hourBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].minuteBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].secondBuckets)):E.FacetCategories[b].dayBuckets.length>1?(r[b+1]+=CreateBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].dayBuckets,E.FacetCategories[b].hourBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].decadeBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].yearBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].monthBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].minuteBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].secondBuckets)):E.FacetCategories[b].hourBuckets.length>1?(r[b+1]+=CreateBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].hourBuckets,E.FacetCategories[b].minuteBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].decadeBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].yearBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].monthBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].dayBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].secondBuckets)):E.FacetCategories[b].minuteBuckets.length>1?(r[b+1]+=CreateBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].minuteBuckets,E.FacetCategories[b].secondBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].decadeBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].yearBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].monthBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].dayBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].hourBuckets)):E.FacetCategories[b].secondBuckets.length>1&&(r[b+1]+=CreateBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].secondBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].decadeBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].yearBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].monthBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].dayBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].hourBuckets),r[b+1]+=CreateHiddenBucketizedDateTimeFacets(E.FacetCategories[b].Name,E.FacetCategories[b].minuteBuckets)),r[b+1]+=CreateDatetimeNoInfoFacet(E.FacetCategories[b].Name),r[b+1]+=CreateCustomRange(E.FacetCategories[b].Name)):E.FacetCategories[b].Type==PivotViewer.Models.FacetType.String||E.FacetCategories[b].Type==PivotViewer.Models.FacetType.Link?(r[b+1]+=void 0!=E.FacetCategories[b].CustomSort||null!=E.FacetCategories[b].CustomSort?"<span class='pv-filterpanel-accordion-facet-sort' customSort='"+E.FacetCategories[b].CustomSort.Name+"'>Sort: "+E.FacetCategories[b].CustomSort.Name+"</span>":"<span class='pv-filterpanel-accordion-facet-sort'>Sort: A-Z</span>",r[b+1]+=CreateStringFacet(E.FacetCategories[b].Name)):E.FacetCategories[b].Type==PivotViewer.Models.FacetType.Number&&(r[b+1]+="<div id='pv-filterpanel-category-numberitem-"+CleanName(E.FacetCategories[b].Name)+"'></div>"),r[b+1]+="</div>",s[b]="<option value='"+CleanName(E.FacetCategories[b].Name)+"' label='"+E.FacetCategories[b].Name+"'>"+E.FacetCategories[b].Name+"</option>"}r[r.length]="</div>",a(".pv-filterpanel").append(r.join(""));for(var b=0;b<E.FacetCategories.length;b++)E.FacetCategories[b].IsFilterVisible&&SortFacetItems(E.FacetCategories[b].Name);a(".pv-filterpanel-accordion").css("height",a(".pv-filterpanel").height()-a(".pv-filterpanel-search").height()-75+"px"),a(".pv-filterpanel-accordion").accordion({}),a(".pv-toolbarpanel-sortcontrols").append('<select class="pv-toolbarpanel-sort">'+s.join("")+"</select>");for(var b=0;b<g.length;b++)CreateNumberFacet(CleanName(g[b].Facet),g[b].Values)},CreateBucketizedDateTimeFacets=function(a,b,c){var d=["<ul class='pv-filterpanel-accordion-facet-list'>"];if(b)for(var e=0;e<b.length;e++){var f=e+1;d[f]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-"+CleanName(a)+"__"+CleanName(b[e].Name.toString())+"'>",d[f]+="<input itemvalue='"+CleanName(b[e].Name.toString())+"' itemfacet='"+CleanName(a.toString())+"' class='pv-facet-facetitem' type='checkbox' />",d[f]+="<span class='pv-facet-facetitem-label' title='"+b[e].Name+"'>"+b[e].Name+"</span>",d[f]+="<span class='pv-facet-facetitem-count'>0</span>",d[f]+="</li>"}if(d[b.length+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-LineBreak' style='border-bottom:thin solid #E2E2E2;'></li>",d[b.length+2]="</ul>",d[b.length+3]="<ul class='pv-filterpanel-accordion-facet-list'>",c)for(var e=0;e<c.length;e++){var f=e+4+b.length;d[f]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-"+CleanName(a)+"__"+CleanName(c[e].Name.toString())+"'>",d[f]+="<input itemvalue='"+CleanName(c[e].Name.toString())+"' itemfacet='"+CleanName(a.toString())+"' class='pv-facet-facetitem' type='checkbox' />",d[f]+="<span class='pv-facet-facetitem-label' title='"+c[e].Name+"'>"+c[e].Name+"</span>",d[f]+="<span class='pv-facet-facetitem-count'>0</span>",d[f]+="</li>"}return d[b.length+c.length+4]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-LineBreak2' style='border-bottom:thin solid #E2E2E2;'></li>",d[b.length+c.length+5]="</ul>",d.join("")},CreateHiddenBucketizedDateTimeFacets=function(a,b){var c=["<ul class='pv-filterpanel-accordion-facet-list' style='visibility:hidden;display:none'>"];if(b){for(var d=0;d<b.length;d++){var e=d+1;c[e]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-"+CleanName(a)+"__"+CleanName(b[d].Name.toString())+"' style='visibility:hidden'>",c[e]+="<input itemvalue='"+CleanName(b[d].Name.toString())+"' itemfacet='"+CleanName(a.toString())+"' class='pv-facet-facetitem' type='checkbox' />",c[e]+="<span class='pv-facet-facetitem-label' title='"+b[d].Name+"'>"+b[d].Name+"</span>",c[e]+="<span class='pv-facet-facetitem-count'>0</span>",c[e]+="</li>"}c[c.length]="<li class='pv-filterpanel-accordion-facet-list-item'  style='border-bottom:thin solid #E2E2E2;' style='visibility:hidden'></li>",c[c.length]="</ul>"}return c.join("")},CreateCustomRange=function(a){var b=["<ul class='pv-filterpanel-accordion-facet-list'>"];return b[1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='pv-facet-item-"+CleanName(a)+"___CustomRange'>",b[1]+="<input itemvalue='CustomRange' itemfacet='"+CleanName(a)+"' class='pv-facet-facetitem' type='checkbox' />",b[1]+="<span class='pv-facet-facetitem-label' title='Custom Range'>Custom Range</span>",b[1]+="</li>",b[1]+="<ul class='pv-filterpanel-accordion-facet-list'>",b[1]+="<li class='pv-filterpanel-accordion-facet-list-item' id='pv-custom-range-"+CleanName(a)+"__Start' style='visibility:hidden;float:right'>",b[1]+="<span class='pv-facet-customrange-label' title='Start Date' >Start:</span>",b[1]+="<input itemvalue='CustomRangeStart' itemfacet='"+CleanName(a)+"' id='pv-custom-range-"+CleanName(a)+"__StartDate' class='pv-facet-customrange' type='text'/>",b[1]+="</li>",b[1]+="<li class='pv-filterpanel-accordion-facet-list-item' id='pv-custom-range-"+CleanName(a)+"__Finish' style='visibility:hidden;float:right'>",b[1]+="<span class='pv-facet-customrange-label' title='End Date'>End:</span>",b[1]+="<input itemvalue='CustomRangeFinish' itemfacet='"+CleanName(a)+"' id='pv-custom-range-"+CleanName(a)+"__FinishDate' class='pv-facet-customrange' type='text'/>",b[1]+="</li>",b[b.length]="</ul>",b.join("")},CreateDatetimeNoInfoFacet=function(a){for(var b=["<ul class='pv-filterpanel-accordion-facet-list'>"],c=0;c<f.length;c++)f[c].facet==a&&"(no info)"==f[c].itemValue&&(b[1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+f[c].itemId+"'>",b[1]+="<input itemvalue='"+CleanName(f[c].itemValue)+"' itemfacet='"+CleanName(a)+"' class='pv-facet-facetitem' type='checkbox' />",b[1]+="<span class='pv-facet-facetitem-label' title='"+f[c].itemValue+"'>"+f[c].itemValue+"</span>",b[1]+="<span class='pv-facet-facetitem-count'>0</span>",b[1]+="</li>");return b[b.length]="<li class='pv-filterpanel-accordion-facet-list-item'  style='border-bottom:thin solid #E2E2E2;'></li>",b[b.length]="</ul>",b.join("")},CreateStringFacet=function(a){for(var b=["<ul class='pv-filterpanel-accordion-facet-list'>"],c=0;c<f.length;c++)f[c].facet==a&&(b[c+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+f[c].itemId+"'>",b[c+1]+="<input itemvalue='"+CleanName(f[c].itemValue)+"' itemfacet='"+CleanName(a)+"' class='pv-facet-facetitem' type='checkbox' />",b[c+1]+="<span class='pv-facet-facetitem-label' title='"+f[c].itemValue+"'>"+f[c].itemValue+"</span>",b[c+1]+="<span class='pv-facet-facetitem-count'>0</span>",b[c+1]+="</li>");return b[b.length]="</ul>",b.join("")},CreateNumberFacet=function(b,c){var d=165,e=80,f=a("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(b));f.empty(),f.append("<span class='pv-filterpanel-numericslider-range-val'>&nbsp;</span>");for(var g="<svg class='pv-filterpanel-accordion-facet-chart' width='"+d+"' height='"+e+"'>",h=PivotViewer.Utils.Histogram(c),i=.5+d/h.BinCount|0,j=0,k=0,l=h.Histogram.length;l>k;k++)j=j<h.Histogram[k].length?h.Histogram[k].length:j;for(var k=0,l=h.Histogram.length;l>k;k++){var m=.5+e/(j/h.Histogram[k].length)|0,n=.5+i*k|0;g+="<rect x='"+n+"' y='"+(e-m)+"' width='"+i+"' height='"+m+"'></rect>"}f.append(g+"</svg>");var o=a("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(b));o.append('</span><div id="pv-filterpanel-numericslider-'+b+'" class="pv-filterpanel-numericslider"></div><span class="pv-filterpanel-numericslider-range-min">'+h.Min+'</span><span class="pv-filterpanel-numericslider-range-max">'+h.Max+"</span>");var p=a("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(b));p.slider({range:!0,min:h.Min,max:h.Max,values:[h.Min,h.Max],slide:function(b,c){a(this).parent().find(".pv-filterpanel-numericslider-range-val").text(c.values[0]+" - "+c.values[1])},stop:function(b,c){var d=a(this),e=d.slider("option","min"),f=d.slider("option","max");c.values[0]>e||c.values[1]<f?d.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"):c.values[0]==e&&c.values[1]==f&&d.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection(!1)}})},CreateViews=function(){var c=a(".pv-viewpanel"),d=B.width(),f=a(".pv-mainpanel").height(),g=a(".pv-filterpanel").width()+18,h=4;e.push(new PivotViewer.Views.GridView),e.push(new PivotViewer.Views.GraphView),e.push(new PivotViewer.Views.TableView);for(var i=0;i<e.length;i++)try{if(e[i]instanceof PivotViewer.Views.IPivotViewerView)e[i].Setup(d,f,g,h,b.GetMaxTileRatio()),c.append("<div class='pv-viewpanel-view' id='pv-viewpanel-view-"+i+"'>"+e[i].GetUI()+"</div>"),a(".pv-toolbarpanel-viewcontrols").append("<div class='pv-toolbarpanel-view' id='pv-toolbarpanel-view-"+i+"' title='"+e[i].GetViewName()+"'><img id='pv-viewpanel-view-"+i+"-image' src='"+e[i].GetButtonImage()+"' alt='"+e[i].GetViewName()+"' /></div>");else{var j="";j+="View does not inherit from PivotViewer.Views.IPivotViewerView<br>",a(".pv-wrapper").append('<div id="pv-view-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+j+"</p></div></div>"),window.open("#pv-view-error","_self")}}catch(k){alert(k.Message)}e[1].SetFacetCategories(E),e[2].SetFacetCategories(E)},global.setMapReady=function(){D=!0,SelectView(3,!0)},SelectView=function(b,c){if(3==b&&!D&&d){var f=document.createElement("script");return f.type="text/javascript",f.src="https://maps.googleapis.com/maps/api/js?key="+d+"&sensor=false&callback=global.setMapReady",void document.body.appendChild(f)}if(3!=b||d){for(var g=0;g<e.length;g++)b!=g&&(a("#pv-viewpanel-view-"+g+"-image").attr("src",e[g].GetButtonImage()),e[g].Deactivate(),e[g].init=!1);a("#pv-viewpanel-view-"+b+"-image").attr("src",e[b].GetButtonImageSelected()),1!=o||2!=b&&3!=b||(e[0].Activate(),e[0].init=c,o=0,FilterCollection(!0)),e[b].Activate(),e[b].init=c,o=b,1==b&&(a.publish("/PivotViewer/Views/Item/Selected",[{id:"",bkt:0}]),r=""),FilterCollection(!0)}else{var h="";h+='Viewing the data on Google maps requires an API key. This can be obtained from <a href="https://code.google.com/apis/console/?noredirect" target="_blank">here</a>',a(".pv-wrapper").append('<div id="pv-nomapkey-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+h+"</p></div></div>");{setTimeout(function(){window.open("#pv-nomapkey-error","_self")},1e3)}}},SortFacetItems=function(b){if(E.GetFacetCategoryByName(b).Type!=PivotViewer.Models.FacetType.DateTime){var c=a("#pv-cat-"+PivotViewer.Utils.EscapeMetaChars(CleanName(b))+" ul"),d=c.prev().text().replace("Sort: ",""),e=c.children("li").get();if("A-Z"==d)e.sort(function(b,c){var d=a(b).children().first().attr("itemvalue"),e=a(c).children().first().attr("itemvalue");return e>d?1:d>e?-1:0});else if("Quantity"==d)e.sort(function(b,c){var d=parseInt(a(b).children(".pv-facet-facetitem-count").text()),e=parseInt(a(c).children(".pv-facet-facetitem-count").text());return e>d?-1:d>e?1:0});else{var f=E.GetFacetCategoryByName(b);if(void 0!=f.CustomSort){for(var g=[],h=f.CustomSort.SortValues.length-1;h>-1;h-=1)for(var i=0;i<e.length;i++)f.CustomSort.SortValues[h]==a(e[i]).children(".pv-facet-facetitem-label").text()&&(g.push(e[i]),found=!0);e=g}}for(var h=0;h<e.length;h++)c.prepend(e[h])}},ApplyViewerState=function(){null!=A.Facet&&(a(".pv-toolbarpanel-sort option[value="+CleanName(A.Facet)+"]").prop("selected","selected"),x=a(".pv-toolbarpanel-sort :selected").attr("label"),Debug.Log("current sort "+x));for(var b=0,c=A.Filters.length;c>b;b++)for(var d=!1,e=0,f=A.Filters[b].Predicates.length;f>e;e++){var g=A.Filters[b].Predicates[e].Operator;if("GT"==g||"GE"==g||"LT"==g||"LE"==g){var h=a("#pv-filterpanel-numericslider-"+CleanName(A.Filters[b].Facet));if(h.length>0){var i=parseFloat(A.Filters[b].Predicates[e].Value);switch(g){case"GT":h.slider("values",0,i+1);break;case"GE":h.slider("values",0,i);break;case"LT":h.slider("values",1,i-1);break;case"LE":h.slider("values",1,i)}h.parent().find(".pv-filterpanel-numericslider-range-val").text(h.slider("values",0)+" - "+h.slider("values",1)),h.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")}else{var j=CleanName(A.Filters[b].Facet),k=a("#pv-facet-item-"+j+"___CustomRange")[0].firstElementChild;switch(k.checked=!0,d||(GetCustomDateRange(j),d=!0),g){case"GE":a("#pv-custom-range-"+j+"__StartDate")[0].value=new Date(A.Filters[b].Predicates[e].Value),CustomRangeChanged(a("#pv-custom-range-"+j+"__StartDate")[0]);break;case"LE":a("#pv-custom-range-"+j+"__FinishDate")[0].value=new Date(A.Filters[b].Predicates[e].Value),CustomRangeChanged(a("#pv-custom-range-"+j+"__FinishDate")[0])}}}else"EQ"==g?SelectStringFacetItem(CleanName(A.Filters[b].Facet),CleanName(A.Filters[b].Predicates[e].Value)):"NT"==g&&SelectStringFacetItem(CleanName(A.Filters[b].Facet),"_no_info_")}},SelectStringFacetItem=function(b,c){var d=a('.pv-facet-facetitem[itemfacet="'+b+'"][itemvalue="'+c+'"]');d.prop("checked",!0),d.parent().parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")},FilterCollection=function(c){var d=[],f=[],g=a(".pv-toolbarpanel-sort option:selected").attr("label");Debug.Log("sort "+g),c||(r="");var h=a(".pv-facet-facetitem:checked");a(".pv-filterpanel-clearall").css("visibility","hidden");for(var i=[],j=[],s=0;s<h.length;s++){var t=C[a(h[s]).attr("itemfacet")],x=C[a(h[s]).attr("itemvalue")],y=E.GetFacetCategoryByName(t);if(y.Type==PivotViewer.Models.FacetType.String){for(var z=!1,A=0;A<i.length;A++)i[A].facet==t&&(i[A].facetValue.push(x),z=!0);z||i.push({facet:t,facetValue:[x]}),a.inArray(t,f)<0&&f.push(t)}else if(y.Type==PivotViewer.Models.FacetType.DateTime){var B=a("#pv-custom-range-"+CleanName(t)+"__StartDate")[0].value,D=a("#pv-custom-range-"+CleanName(t)+"__FinishDate")[0].value;if(B&&D)j.push({facet:t,facetValue:[x],minDate:new Date(B),maxDate:new Date(D)});else{for(var z=!1,A=0;A<j.length;A++)j[A].facet==t&&(j[A].facetValue.push(x),z=!0);z||j.push({facet:t,facetValue:[x]})}a.inArray(t,f)<0&&f.push(t)}}for(var F=[],s=0,G=E.FacetCategories.length;G>s;s++)if(E.FacetCategories[s].Type==PivotViewer.Models.FacetType.Number){var H=a("#pv-filterpanel-category-numberitem-"+CleanName(E.FacetCategories[s].Name)),I=a(H).find(".pv-filterpanel-numericslider");if(I.length>0){var J=I.slider("values"),K=I.slider("option","max"),L=I.slider("option","min");if(J[0]!=L||J[1]!=K){var t=E.FacetCategories[s].Name;F.push({facet:t,selectedMin:J[0],selectedMax:J[1],rangeMin:L,rangeMax:K}),a.inArray(t,f)<0&&f.push(t)}}}for(var s=0,G=E.Items.length;G>s;s++){for(var M=0,N=0,O=i.length;O>N;N++)for(var P=0,Q=i[N].facetValue.length;Q>P;P++)if("(no info)"==i[N].facetValue[P]){for(var R=!1,A=0,S=E.Items[s].Facets.length;S>A;A++)E.Items[s].Facets[A].Name==i[N].facet&&(R=!0);0==R&&M++}for(var A=0,S=E.Items[s].Facets.length;S>A;A++)for(var N=0,O=i.length;O>N;N++){var T=0;if(E.Items[s].Facets[A].Name==i[N].facet)for(var U=0,V=E.Items[s].Facets[A].FacetValues.length;V>U;U++)for(var P=0,Q=i[N].facetValue.length;Q>P;P++)E.Items[s].Facets[A].FacetValues[U].Value==i[N].facetValue[P]&&T++;T>0&&M++}if(M==i.length){for(var N=0,O=F.length;O>N;N++)if("(no info)"==F[N].selectedMin){for(var R=!1,A=0,S=E.Items[s].Facets.length;S>A;A++)E.Items[s].Facets[A].Name==F[N].facet&&(R=!0);0==R&&M++}for(var A=0,S=E.Items[s].Facets.length;S>A;A++)for(var N=0,O=F.length;O>N;N++)if(E.Items[s].Facets[A].Name==F[N].facet)for(var U=0,V=E.Items[s].Facets[A].FacetValues.length;V>U;U++){var W=parseFloat(E.Items[s].Facets[A].FacetValues[U].Value);!isNaN(W)&&W>=F[N].selectedMin&&W<=F[N].selectedMax&&M++}if(M==i.length+F.length){for(var N=0,O=j.length;O>N;N++)for(var P=0,Q=j[N].facetValue.length;Q>P;P++)if("(no info)"==j[N].facetValue[P]){for(var R=!1,A=0,S=E.Items[s].Facets.length;S>A;A++)E.Items[s].Facets[A].Name==j[N].facet&&(R=!0);0==R&&M++}for(var A=0,S=E.Items[s].Facets.length;S>A;A++)for(var N=0,O=j.length;O>N;N++){var T=0;if(E.Items[s].Facets[A].Name==j[N].facet)if(j[N].minDate&&j[N].maxDate){var X=new Date(E.Items[s].Facets[A].FacetValues[0].Value);X<=j[N].maxDate&&X>=j[N].minDate&&T++}else{for(var y=E.GetFacetCategoryByName(j[N].facet),P=0,Q=j[N].facetValue.length;Q>P;P++)for(l=0;l<y.decadeBuckets.length;l++)if(y.decadeBuckets[l].Name==j[N].facetValue[P])for(var U=0;U<y.decadeBuckets[l].Items.length;U++)y.decadeBuckets[l].Items[U]==E.Items[s].Id&&T++;for(var P=0,Q=j[N].facetValue.length;Q>P;P++)for(l=0;l<y.yearBuckets.length;l++)if(y.yearBuckets[l].Name==j[N].facetValue[P])for(var U=0;U<y.yearBuckets[l].Items.length;U++)y.yearBuckets[l].Items[U]==E.Items[s].Id&&T++;
for(var P=0,Q=j[N].facetValue.length;Q>P;P++)for(l=0;l<y.monthBuckets.length;l++)if(y.monthBuckets[l].Name==j[N].facetValue[P])for(var U=0;U<y.monthBuckets[l].Items.length;U++)y.monthBuckets[l].Items[U]==E.Items[s].Id&&T++;for(var P=0,Q=j[N].facetValue.length;Q>P;P++)for(l=0;l<y.dayBuckets.length;l++)if(y.dayBuckets[l].Name==j[N].facetValue[P])for(var U=0;U<y.dayBuckets[l].Items.length;U++)y.dayBuckets[l].Items[U]==E.Items[s].Id&&T++;for(var P=0,Q=j[N].facetValue.length;Q>P;P++)for(l=0;l<y.hourBuckets.length;l++)if(y.hourBuckets[l].Name==j[N].facetValue[P])for(var U=0;U<y.hourBuckets[l].Items.length;U++)y.hourBuckets[l].Items[U]==E.Items[s].Id&&T++;for(var P=0,Q=j[N].facetValue.length;Q>P;P++)for(l=0;l<y.minuteBuckets.length;l++)if(y.minuteBuckets[l].Name==j[N].facetValue[P])for(var U=0;U<y.minuteBuckets[l].Items.length;U++)y.minuteBuckets[l].Items[U]==E.Items[s].Id&&T++;for(var P=0,Q=j[N].facetValue.length;Q>P;P++)for(l=0;l<y.secondBuckets.length;l++)if(y.secondBuckets[l].Name==j[N].facetValue[P])for(var U=0;U<y.secondBuckets[l].Items.length;U++)y.secondBuckets[l].Items[U]==E.Items[s].Id&&T++}T>0&&M++}M==i.length+F.length+j.length&&(d.push(E.Items[s].Id),i.length+F.length+j.length>0&&a(".pv-filterpanel-clearall").css("visibility","visible"))}}}m=F,k=i,n=j,a(".pv-viewpanel-view").hide(),a("#pv-viewpanel-view-"+o).show(),FilterFacets(d,f),UpdateBreadcrumbNavigation(i,F,j),b.SetCircularEasingBoth(),w?(e[o].Filter(p,d,g,i,c,r),2!=o&&3!=o||c||e[0].Filter(p,d,g,i,!1,"")):(2==o?(e[o].SetSelectedFacet(v),e[o].Filter(p,d,g,i,c,u)):e[o].Filter(p,d,g,i,c,r),w=!0);var Y=[];if("Graph View"==e[o].GetViewName())Y=e[o].GetSortedFilter();else for(var s=0;s<e[o].tiles.length;s++){var Z=a.inArray(e[o].tiles[s].facetItem.Id,d);if(Z>=0){var $=new Object;$.Id=e[o].tiles[s].facetItem.Id,$.Bucket=0,Y.push($)}}q=Y,UpdateItemCount(),UpdateBookmark(),DeselectInfoPanel()},BucketCounts=function(b,c,d){for(var e=0;e<b.length;e++){for(var f=a("#pv-facet-item-"+CleanName(c)+"__"+CleanName(b[e].Name.toString())),g=0,h=0;h<d.length;h++)-1!=b[e].Items.indexOf(d[h])&&g++;f.find("span").last().text(g),0==g?f.hide():f.show()}},GetDateTimeItemCounts=function(b){if(b.decadeBuckets.length>0)for(var c=0;c<b.decadeBuckets.length;c++){var d=a("#pv-facet-item-"+CleanName(b.Name)+"__"+CleanName(b.decadeBuckets[c].Name.toString()));d.find("span").last().text(b.decadeBuckets[c].Items.length),d.show()}if(b.yearBuckets.length>0)for(var c=0;c<b.yearBuckets.length;c++){var d=a("#pv-facet-item-"+CleanName(b.Name)+"__"+CleanName(b.yearBuckets[c].Name.toString()));d.find("span").last().text(b.yearBuckets[c].Items.length),d.show()}if(b.monthBuckets.length>0)for(var c=0;c<b.monthBuckets.length;c++){var d=a("#pv-facet-item-"+CleanName(b.Name)+"__"+CleanName(b.monthBuckets[c].Name.toString()));d.find("span").last().text(b.monthBuckets[c].Items.length),d.show()}if(b.dayBuckets.length>0)for(var c=0;c<b.dayBuckets.length;c++){var d=a("#pv-facet-item-"+CleanName(b.Name)+"__"+CleanName(b.dayBuckets[c].Name.toString()));d.find("span").last().text(b.dayBuckets[c].Items.length),d.show()}if(b.hourBuckets.length>0)for(var c=0;c<b.hourBuckets.length;c++){var d=a("#pv-facet-item-"+CleanName(b.Name)+"__"+CleanName(b.hourBuckets[c].Name.toString()));d.find("span").last().text(b.hourBuckets[c].Items.length),d.show()}if(b.minuteBuckets.length>0)for(var c=0;c<b.minuteBuckets.length;c++){var d=a("#pv-facet-item-"+CleanName(b.Name)+"__"+CleanName(b.minuteBuckets[c].Name.toString()));d.find("span").last().text(b.minuteBuckets[c].Items.length),d.show()}if(b.secondBuckets.length>0)for(var c=0;c<b.secondBuckets.length;c++){var d=a("#pv-facet-item-"+CleanName(b.Name)+"__"+CleanName(b.secondBuckets[c].Name.toString()));d.find("span").last().text(b.secondBuckets[c].Items.length),d.show()}},FilterFacets=function(b,c){if(b.length!=E.Items.length){for(var d=[],e=[],h=b.length-1;h>-1;h-=1)for(var i=E.GetItemById(b[h]),j=0;j<E.FacetCategories.length;j++)if(E.FacetCategories[j].IsFilterVisible){for(var k=!1,l=i.Facets.length-1;l>-1;l-=1)if(i.Facets[l].Name==E.FacetCategories[j].Name){if(a.inArray(i.Facets[l].Name,c)<0){var m=E.GetFacetCategoryByName(i.Facets[l].Name);if(m.IsFilterVisible)for(var n=i.Facets[l].FacetValues.length-1;n>-1;n-=1)if(m.Type==PivotViewer.Models.FacetType.String){for(var o={item:"#"+PivotViewer.Utils.EscapeMetaChars("pv-facet-item-"+CleanName(i.Facets[l].Name)+"__"+CleanName(i.Facets[l].FacetValues[n].Value)),count:1},p=!1,q=d.length-1;q>-1;q-=1)if(d[q].item==o.item){d[q].count+=1,p=!0;break}p||d.push(o)}else if(m.Type==PivotViewer.Models.FacetType.Number){for(var r=!1,q=0;q<e.length;q++)if(e[q].Facet==i.Facets[l].Name){e[q].Values.push(i.Facets[l].FacetValues[n].Value),r=!0;break}r||e.push({Facet:i.Facets[l].Name,Values:[i.Facets[l].FacetValues[n].Value]})}}k=!0}if(!k){for(var o={item:"#"+PivotViewer.Utils.EscapeMetaChars("pv-facet-item-"+CleanName(E.FacetCategories[j].Name)+"__"+CleanName("(no info)")),count:1},p=!1,q=d.length-1;q>-1;q-=1)if(d[q].item==o.item){d[q].count+=1,p=!0;break}p||d.push(o)}}for(var h=f.length-1;h>-1;h-=1)if(a.inArray(f[h].facet,c)<0){for(var p=!1,l=d.length-1;l>-1;l-=1)if(d[l].item==f[h].itemId){p=!0;break}p||a("#"+PivotViewer.Utils.EscapeMetaChars(f[h].itemId)).hide()}else a("#"+PivotViewer.Utils.EscapeMetaChars(f[h].itemId)).find("span").last().text(f[h].count);for(var h=d.length-1;h>-1;h-=1){var s=a(d[h].item);if(s.length>0){s.show();var t=s.find("span").last();t.text(d[h].count)}}for(var h=0;h<e.length;h++)CreateNumberFacet(CleanName(e[h].Facet),e[h].Values);for(var h=0;h<E.FacetCategories.length;h++)if(a.inArray(E.FacetCategories[h].Name,c)<0&&E.FacetCategories[h].Type==PivotViewer.Models.FacetType.DateTime){var u=E.FacetCategories[h];u.decadeBuckets.length>0&&"hidden"!=a("#pv-facet-item-"+CleanName(u.Name)+"__"+CleanName(u.decadeBuckets[0].Name.toString())).css("visibility")&&BucketCounts(u.decadeBuckets,u.Name,b),u.yearBuckets.length>0&&"hidden"!=a("#pv-facet-item-"+CleanName(u.Name)+"__"+CleanName(u.yearBuckets[0].Name.toString())).css("visibility")&&BucketCounts(u.yearBuckets,u.Name,b),u.monthBuckets.length>0&&"hidden"!=a("#pv-facet-item-"+CleanName(u.Name)+"__"+CleanName(u.monthBuckets[0].Name.toString())).css("visibility")&&BucketCounts(u.monthBuckets,u.Name,b),u.dayBuckets.length>0&&"hidden"!=a("#pv-facet-item-"+CleanName(u.Name)+"__"+CleanName(u.dayBuckets[0].Name.toString())).css("visibility")&&BucketCounts(u.dayBuckets,u.Name,b),u.hourBuckets.length>0&&"hidden"!=a("#pv-facet-item-"+CleanName(u.Name)+"__"+CleanName(u.hourBuckets[0].Name.toString())).css("visibility")&&BucketCounts(u.hourBuckets,u.Name,b),u.minuteBuckets.length>0&&"hidden"!=a("#pv-facet-item-"+CleanName(u.Name)+"__"+CleanName(u.minuteBuckets[0].Name.toString())).css("visibility")&&BucketCounts(u.minuteBuckets,u.Name,b),u.secondBuckets.length>0&&"hidden"!=a("#pv-facet-item-"+CleanName(u.Name)+"__"+CleanName(u.secondBuckets[0].Name.toString())).css("visibility")&&BucketCounts(u.secondBuckets,u.Name,b)}}else{for(var h=0;h<E.FacetCategories.length;h++)E.FacetCategories[h].Type==PivotViewer.Models.FacetType.DateTime&&GetDateTimeItemCounts(E.FacetCategories[h],b);for(var h=f.length-1;h>-1;h-=1){var i=a("#"+PivotViewer.Utils.EscapeMetaChars(f[h].itemId));i.show(),i.find("span").last().text(f[h].count)}for(var h=0;h<g.length;h++)CreateNumberFacet(CleanName(g[h].Facet),g[h].Values)}},UpdateBreadcrumbNavigation=function(b,c,d){var e=a(".pv-toolbarpanel-facetbreadcrumb");if(e.empty(),0!=b.length||0!=c.length||0!=d.length){for(var f="|",g=0,h=b.length;h>g;g++)f+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+b[g].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",f+=b[g].facetValue.join(", "),f+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>";for(var g=0,h=c.length;h>g;g++)f+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+c[g].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",f+=c[g].selectedMin==c[g].rangeMin?"Under "+c[g].selectedMax:c[g].selectedMax==c[g].rangeMax?"Over "+c[g].selectedMin:c[g].selectedMin+" - "+c[g].selectedMax,f+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>";for(var g=0,h=d.length;h>g;g++)d[g].maxDate&&d[g].minDate?(f+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+d[g].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",f+="Between "+d[g].minDate+" and "+d[g].maxDate,f+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>"):(f+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+d[g].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",f+=d[g].facetValue.join(", "),f+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>");e.append(f)}},UpdateItemCount=function(){var b=a(".pv-toolbarpanel-itemcount");b.empty(),b.append(q.length)},DeselectInfoPanel=function(){a(".pv-infopanel").fadeOut(),a(".pv-infopanel-heading").empty(),a(".pv-infopanel-details").empty()},GetItemIds=function(a,b){for(var c=[],d=0;d<E.Items.length;d++){for(var e=!1,f=0;f<E.Items[d].Facets.length;f++)if(E.Items[d].Facets[f].Name==a){for(var g=0;g<E.Items[d].Facets[f].FacetValues.length;g++)b==E.Items[d].Facets[f].FacetValues[g].Value&&c.push(E.Items[d].Id);e=!0}e||"(no info)"!=b||c.push(E.Items[d].Id)}return c},GetItem=function(a){for(var b=0;b<E.Items.length;b++)if(E.Items[b].Id==a)return E.Items[b];return null},UpdateBookmark=function(){var a="#",b=o+1;a+="$view$="+b,x&&(a+="&$facet0$="+x),r&&(a+="&$selection$="+r.Id),2==o&&e[o].GetSelectedFacet()&&(a+="&$tableFacet$="+e[o].GetSelectedFacet()),3==o&&(e[o].GetMapCentreX()&&(a+="&$mapCentreX$="+e[o].GetMapCentreX()),e[o].GetMapCentreY()&&(a+="&$mapCentreY$="+e[o].GetMapCentreY()),e[o].GetMapType()&&(a+="&$mapType$="+e[o].GetMapType()),e[o].GetMapZoom()&&(a+="&$mapZoom$="+e[o].GetMapZoom())),4==o&&e[o].GetSelectedFacet()&&(a+="&$timelineFacet$="+e[o].GetSelectedFacet());var c=E.CollectionName;if(m.length+k.length>0&&(c+=" | "),k.length>0)for(i=0;i<k.length;i++){for(j=0;j<k[i].facetValue.length;j++)a+="&",a+=k[i].facet,a+="=EQ."+k[i].facetValue[j];c+=k[i].facet+": ",c+=k[i].facetValue.join(", "),i<k.length-1&&(c+=" > ")}if(m.length>0)for(i=0;i<m.length;i++)a+="&",a+=m[i].facet,c+=m[i].facet+": ",m[i].selectedMin==m[i].rangeMin?(a+="=LE."+m[i].selectedMax,c+="Under "+m[i].selectedMax):m[i].selectedMax==m[i].rangeMax?(a+="=GE."+m[i].selectedMin,c+="Over "+m[i].selectedMin):(a+="=GE."+m[i].selectedMin+"_LE."+m[i].selectedMax,c+="Between "+m[i].selectedMin+" and "+m[i].selectedMax),i<m.length-1&&(c+=" > ");if(n.length>0)for(i=0;i<n.length;i++){for(j=0;j<n[i].facetValue.length;j++)a+="&",a+=n[i].facet,c+=n[i].facet+": ",n[i].maxDate&&n[i].minDate?(a+="=GE."+n[i].minDate+"_LE."+n[i].maxDate,c+="Between "+n[i].minDate+" and "+n[i].maxDate):(a+="=EQ."+n[i].facetValue[j],c+=n[i].facetValue.join(", "));i<n.length-1&&(c+=" > ")}void 0!=typeof SetBookmark&&"function"==typeof SetBookmark&&SetBookmark(E.CXMLBaseNoProxy,a,c)},CleanName=function(a){return name=a.replace(/[^\w]/gi,"_"),C[name]=a,name},a.subscribe("/PivotViewer/Models/Collection/Loaded",function(){InitTileCollection()}),a.subscribe("/PivotViewer/ImageController/Collection/Loaded",function(){InitPivotViewer();var b=a(".pv-filterpanel");b.append("<div class='pv-filterpanel-version'><a href=\"#pv-open-version\">About HTHL5 PivotViewer</a></div>"),b.append('<div id="pv-open-version" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>Version: '+a(PivotViewer)[0].Version+'</p><p>The sources are available on <a href="https://github.com/openlink/html5pivotviewer" target="_blank">github</a></p></div></div>')}),a.subscribe("/PivotViewer/Views/Item/Selected",function(b){if(void 0===b.id||null===b.id||""===b.id)return DeselectInfoPanel(),r="",2==o&&e[o].Selected(r.Id),void UpdateBookmark();var c=GetItem(b.id);if(null!=c){var d=!0;a(".pv-infopanel-heading").empty(),a(".pv-infopanel-heading").append('<a href="'+c.Href+'" target="_blank">'+c.Name+"</a></div>");var f=a(".pv-infopanel-details");f.empty(),void 0!=c.Description&&c.Description.length>0&&f.append("<div class='pv-infopanel-detail-description' style='height:100px;'>"+c.Description+"</div><div class='pv-infopanel-detail-description-more'>More</div>"),c.Id==q[0].Id&&c==q[q.length-1]?(a(".pv-infopanel-controls-navright").hide(),a(".pv-infopanel-controls-navrightdisabled").show(),a(".pv-infopanel-controls-navleft").hide(),a(".pv-infopanel-controls-navleftdisabled").show()):c.Id==q[0].Id?(a(".pv-infopanel-controls-navleft").hide(),a(".pv-infopanel-controls-navleftdisabled").show(),a(".pv-infopanel-controls-navright").show(),a(".pv-infopanel-controls-navrightdisabled").hide()):c.Id==q[q.length-1].Id?(a(".pv-infopanel-controls-navright").hide(),a(".pv-infopanel-controls-navrightdisabled").show(),a(".pv-infopanel-controls-navleft").show(),a(".pv-infopanel-controls-navleftdisabled").hide()):(a(".pv-infopanel-controls-navright").show(),a(".pv-infopanel-controls-navrightdisabled").hide(),a(".pv-infopanel-controls-navleft").show(),a(".pv-infopanel-controls-navleftdisabled").hide());for(var g=[],h=0,i=0;i<c.Facets.length;i++){for(var j=!1,k=!1,l=0;l<E.FacetCategories.length;l++)if(E.FacetCategories[l].Name==c.Facets[i].Name&&E.FacetCategories[l].IsMetaDataVisible){j=!0,k=E.FacetCategories[l].IsFilterVisible;break}if(j){g[h]="<div class='pv-infopanel-detail "+(d?"detail-dark":"detail-light")+"'><div class='pv-infopanel-detail-item detail-item-title' pv-detail-item-title='"+c.Facets[i].Name+"'>"+c.Facets[i].Name+"</div>";for(var l=0;l<c.Facets[i].FacetValues.length;l++)g[h]+="<div pv-detail-item-value='"+c.Facets[i].FacetValues[l].Value+"' class='pv-infopanel-detail-item detail-item-value"+(k?" detail-item-value-filter":"")+"'>",g[h]+=null!=c.Facets[i].FacetValues[l].Href?"<a class='detail-item-link' href='"+c.Facets[i].FacetValues[l].Href+"'>"+c.Facets[i].FacetValues[l].Value+"</a>":c.Facets[i].FacetValues[l].Value,g[h]+="</div>";g[h]+="</div>",h++,d=!d}}if(c.Links.length>0){a(".pv-infopanel-related").empty();for(var m=0;m<c.Links.length;m++)a(".pv-infopanel-related").append("<a href='"+c.Links[m].Href+"'>"+c.Links[m].Name+"</a><br>")}return f.append(g.join("")),a(".pv-infopanel").fadeIn(),f.css("height",a(".pv-infopanel").height()-(a(".pv-infopanel-controls").height()+a(".pv-infopanel-heading").height()+a(".pv-infopanel-copyright").height()+a(".pv-infopanel-related").height())-20+"px"),r=c,s=b.bkt,(2==o||4==o)&&e[o].Selected(r.Id),3==o&&e[o].RedrawMarkers(r.Id),void UpdateBookmark()}}),a.subscribe("/PivotViewer/Views/Item/Filtered",function(b){if(void 0!=b&&null!=b){if(1==b.ClearFacetFilters)for(var c=0,d=E.FacetCategories.length;d>c;c++)if(E.FacetCategories[c].Name==b.Facet&&(E.FacetCategories[c].Type==PivotViewer.Models.FacetType.String||E.FacetCategories[c].Type==PivotViewer.Models.FacetType.DateTime))for(var e=a('.pv-facet-facetitem[itemfacet="'+CleanName(b.Facet.toString())+'"]'),f=0;f<e.length;f++)a(e[f]).prop("checked",!1);for(var c=0,d=E.FacetCategories.length;d>c;c++){if(E.FacetCategories[c].Name==b.Facet&&(E.FacetCategories[c].Type==PivotViewer.Models.FacetType.String||E.FacetCategories[c].Type==PivotViewer.Models.FacetType.DateTime))if(b.Values)for(var f=0;f<b.Values.length;f++){var g=a(PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(b.Facet.toString())+"__"+CleanName(b.Values[f].toString()))+" input");g.prop("checked",!0),FacetItemClick(g[0])}else{var g=a(PivotViewer.Utils.EscapeMetaChars("#pv-facet-item-"+CleanName(b.Facet.toString())+"__"+CleanName(b.Item.toString()))+" input");g.prop("checked",!0),FacetItemClick(g[0])}if(E.FacetCategories[c].Name==b.Facet&&E.FacetCategories[c].Type==PivotViewer.Models.FacetType.Number){var h=a("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(b.Facet));FacetSliderDrag(h,b.Item,b.MaxRange)}}}}),a.subscribe("/PivotViewer/Views/Item/Updated",function(){UpdateBookmark()}),a.subscribe("/PivotViewer/Views/ChangeTo/Grid",function(b){var c="";for(t=0;t<p.length;t++)if(p[t].facetItem==b.Item){c=p[t];break}c&&a.publish("/PivotViewer/Views/Canvas/Click",[{x:c._locations[c.selectedLoc].destinationx+c.destinationwidth/2,y:c._locations[c.selectedLoc].destinationy+c.destinationheight/2}])}),a.subscribe("/PivotViewer/Views/Update/GridSelection",function(a){e[0].handleSelection(a.selectedItem,a.selectedTile)}),AttachEventHandlers=function(){a(".pv-toolbarpanel-view").on("click",function(){var a=this.id.substring(this.id.lastIndexOf("-")+1,this.id.length);null!=a&&SelectView(parseInt(a),!1)}),a(".pv-toolbarpanel-sort").on("change",function(){x=a(".pv-toolbarpanel-sort option:selected").attr("label"),Debug.Log("sort change _currentSort "+x),FilterCollection(!1)}),a(".pv-filterpanel-accordion-facet-sort").on("click",function(){var b=a(this),c=b.text(),d=b.parent().prev().children("a").text(),e=b.attr("customSort");a(this).text("Sort: A-Z"==c?"Sort: Quantity":"Sort: Quantity"==c&&void 0==e?"Sort: A-Z":"Sort: Quantity"==c?"Sort: "+e:"Sort: A-Z"),SortFacetItems(d)}),a(".pv-facet-facetitem").on("click",function(){FacetItemClick(this)}),a(".pv-facet-facetitem-label").on("click",function(){var b=a(this).prev(),c=a(this.parentElement.parentElement).find(":checked");1==b.prop("checked")&&c.length<=1?b.prop("checked",!1):b.prop("checked",!0);for(var d=c.length-1;d>-1;d-=1)c[d].getAttribute("itemvalue")!=b[0].getAttribute("itemvalue")&&(c[d].checked=!1);FacetItemClick(b[0])}),a(".pv-filterpanel-export").on("click",function(){output="<html>",output+="<head><title>Export current filter.</title></head>",output+="<body><table><tr><th>Name</th>";for(var a=0;a<E.FacetCategories.length;a++)output+="<th>"+E.FacetCategories[a].Name+"</th>";for(var b=0;b<q.length;b++)for(var c=0;c<p.length;c++)if(p[c].facetItem.Id==q[b].Id){var d=p[c];output+="<tr><td>"+d.facetItem.Name+"</td>";for(var a=0;a<E.FacetCategories.length;a++){for(var e="",f=0;f<d.facetItem.Facets.length;f++)if(d.facetItem.Facets[f].Name==E.FacetCategories[a].Name){for(var g=[],h=0;h<d.facetItem.Facets[f].FacetValues.length;h++)d.facetItem.Facets[f].FacetValues[h].Value&&g.push(d.facetItem.Facets[f].FacetValues[h].Value);e=g.join();break}output+="<td>"+e+"</td>"}output+="</tr>"}output+="</tr></table></body></html>";var i=window.open("","_blank");i.document.write(output),i.document.close()}),a(".pv-filterpanel-clearall").on("click",function(){for(var b=a(".pv-facet-facetitem:checked"),c=0;c<b.length;c++)a(b[c]).prop("checked",!1),"CustomRange"==a(b[c]).attr("itemvalue")&&HideCustomDateRange(a(b[c]).attr("itemfacet"));for(var d=a(".pv-filterpanel-numericslider"),c=0;c<d.length;c++){var e=a(d[c]),f=e.slider("option","min"),g=e.slider("option","max");e.slider("values",0,f),e.slider("values",1,g),e.prev().prev().html("&nbsp;")}a(".pv-filterpanel-search").val(""),a(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection(!1)}),a(".pv-filterpanel-accordion-heading-clear").on("click",function(){var b=this.attributes.facetType.value;if("DateTime"==b)for(var c=a(this.parentElement).next().find(".pv-facet-facetitem:checked"),d=0;d<c.length;d++)a(c[d]).prop("checked",!1),HideCustomDateRange(a(c[d]).attr("itemfacet"));else if("String"==b)for(var c=a(this.parentElement).next().find(".pv-facet-facetitem:checked"),d=0;d<c.length;d++)a(c[d]).prop("checked",!1);else if("Number"==b){var e=a(this.parentElement).next().find(".pv-filterpanel-numericslider"),f=e.slider("option","min"),g=e.slider("option","max");e.slider("values",0,f),e.slider("values",1,g),e.prev().prev().html("&nbsp;")}FilterCollection(!1),a(this).css("visibility","hidden")}),a(".ui-slider-range").on("mousedown",function(){}),a(".pv-facet-customrange").on("change",function(){CustomRangeChanged(this)}),a(".pv-infopanel-details").on("click",".detail-item-value-filter",function(){return a.publish("/PivotViewer/Views/Item/Filtered",[{Facet:a(this).parent().children().attr("pv-detail-item-title"),Item:this.getAttribute("pv-detail-item-value"),Values:null,ClearFacetFilters:!0}]),!1}),a(".pv-infopanel-details").on("click",".pv-infopanel-detail-description-more",function(){var b=a(this),c=a(this).prev();"More"==b.text()?(c.css("height",""),a(this).text("Less")):(c.css("height","100px"),a(this).text("More"))}),a(".pv-infopanel-controls-navleft").on("click",function(){for(var b=0;b<q.length;b++)if(q[b].Id==r.Id&&q[b].Bucket==s){if(b>=0&&a.publish("/PivotViewer/Views/Item/Selected",[{id:q[b-1].Id,bkt:q[b-1].Bucket}]),0==o||1==o)for(var c=0;c<p.length;c++)p[c].facetItem.Id==q[b-1].Id?(p[c].Selected(!0),selectedCol=e[o].GetSelectedCol(p[c],q[b-1].Bucket),selectedRow=e[o].GetSelectedRow(p[c],q[b-1].Bucket),e[o].CentreOnSelectedTile(selectedCol,selectedRow)):p[c].Selected(!1);break}}),a(".pv-infopanel-controls-navright").on("click",function(){for(var b=0;b<q.length;b++)if(q[b].Id==r.Id&&q[b].Bucket==s){if(b<q.length&&(a.publish("/PivotViewer/Views/Item/Selected",[{id:q[b+1].Id,bkt:q[b+1].Bucket}]),0==o||1==o))for(var c=0;c<p.length;c++)p[c].facetItem.Id==q[b+1].Id?(p[c].Selected(!0),selectedCol=e[o].GetSelectedCol(p[c],q[b+1].Bucket),selectedRow=e[o].GetSelectedRow(p[c],q[b+1].Bucket),e[o].CentreOnSelectedTile(selectedCol,selectedRow)):p[c].Selected(!1);break}}),a(".pv-filterpanel-search").on("keyup",function(b){var c=!1,d=[],e=a(".pv-filterpanel-search-autocomplete"),f=FilterCollection,g=SelectStringFacetItem;if(e.empty(),27==b.keyCode)return void a(b.target).blur();for(var i=0,j=h.length;j>i;i++){var k=h[i].Value.toLowerCase();k.indexOf(b.target.value.toLowerCase())>=0&&-1==a.inArray(k,d)&&(d.push(k),e.append('<span facet="'+h[i].Facet+'">'+h[i].Value+"</span>"),13==b.keyCode&&(SelectStringFacetItem(CleanName(h[i].Facet),CleanName(h[i].Value)),c=!0))}a(".pv-filterpanel-search-autocomplete > span").on("mousedown",function(b){b.preventDefault(),a(".pv-filterpanel-search").val(b.target.textContent),a(".pv-filterpanel-search-autocomplete").hide(),g(CleanName(b.target.attributes[0].value),CleanName(b.target.textContent)),f()}),d.length>0&&e.show(),c&&FilterCollection(!1)}),a(".pv-filterpanel-search").on("blur",function(b){b.target.value="",a(".pv-filterpanel-search-autocomplete").hide()});var c=a(".pv-viewarea-canvas");c.on("mouseup",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;(!z||0==z.x&&0==z.y)&&a.publish("/PivotViewer/Views/Canvas/Click",[{x:d,y:e}]),y=null,z=!1}),c.on("mouseout",function(){y=null,z=!1}),c.on("mousedown",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;y={x:d,y:e}}),c.on("mousemove",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;null==y?a.publish("/PivotViewer/Views/Canvas/Hover",[{x:d,y:e}]):(z={x:d-y.x,y:e-y.y},y={x:d,y:e},a.publish("/PivotViewer/Views/Canvas/Drag",[z]))}),c.on("mousewheel",function(c,d){var e=a(this).offset(),f=c.clientX-e.left,g=c.clientY-e.top;b.SetQuarticEasingOut(),b.DrawHelpers([{x:f,y:g}]);var h=a(".pv-toolbarpanel-zoomslider").slider("option","value");d>0?h=5>h?5:h+5:0>d&&(h-=5),h=Math.max(0,Math.min(100,h)),a(".pv-toolbarpanel-zoomslider").slider("option","value",h)}),c.on("touchstart",function(b){var c=b.originalEvent,d=a(this).offset(),e=c.touches[0].pageX-d.left,f=c.touches[0].pageY-d.top;y={x:e,y:f}}),c.on("touchmove",function(c){try{var d=c.originalEvent;if(c.preventDefault(),d.touches.length>1){c.preventDefault();for(var e=1e7,f=1e7,g=0,h=0,i=[],j=0;j<d.touches.length;j++)i.push({x:d.touches[j].pageX,y:d.touches[j].pageY}),d.touches[j].pageX<e&&(e=d.touches[j].pageX),d.touches[j].pageX>g&&(g=d.touches[j].pageX),d.touches[j].pageY<f&&(f=d.touches[j].pageY),d.touches[j].pageY>h&&(h=d.touches[j].pageY);var k=(e+g)/2,l=(f+h)/2;return b.SetLinearEasingBoth(),i.push({x:k,y:l}),b.DrawHelpers(i),b.DrawHelperText("Scale: "+d.scale),void a.publish("/PivotViewer/Views/Canvas/Zoom",[{x:k,y:l,scale:d.scale}])}var m=a(this).offset(),n=d.touches[0].pageX-m.left,o=d.touches[0].pageY-m.top;z={x:n-y.x,y:o-y.y},y={x:n,y:o},a.publish("/PivotViewer/Views/Canvas/Drag",[z])}catch(p){Debug.Log(p.message)}}),c.on("touchend",function(b){var c=b.originalEvent;if(1==c.touches.length&&null==y){var d=a(this).offset(),e=c.touches[0].pageX-d.left,f=c.touches[0].pageY-d.top;(!z||0==z.x&&0==z.y)&&a.publish("/PivotViewer/Views/Canvas/Click",[{x:e,y:f}])}y=null,z=!1})},FacetItemClick=function(b){if(1==a(b).prop("checked")){if(a(b.parentElement.parentElement.parentElement).prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"),"CustomRange"==a(b).attr("itemvalue"))return void GetCustomDateRange(a(b).attr("itemfacet"))}else 0==a(b).prop("checked")&&"CustomRange"==a(b).attr("itemvalue")&&HideCustomDateRange(a(b).attr("itemfacet"));FilterCollection(!1)},FacetSliderDrag=function(b,c,d){var e=a(b),f=e.slider("option","min"),g=e.slider("option","max");"(no info)"==c&&(c=0),c>f||g>d?(e.parent().find(".pv-filterpanel-numericslider-range-val").text(c+" - "+d),e.slider("values",0,c),e.slider("values",1,d),e.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")):c==f&&d==g&&e.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection(!1)},Bucketize=function(a,b,c,d){var e=!1;if(0==b.length){var f=new PivotViewer.Models.DateTimeInfo(a,d);b[0]=f,b[0].Items.push(c)}else{for(var g=0;g<b.length;g++)b[g].Name==a&&(b[g].Items.push(c),e=!0);if(!e){var f=new PivotViewer.Models.DateTimeInfo(a,d);f.Items.push(c),b.push(f)}}},CreateDatetimeBuckets=function(){var a=new Array(12);a[0]="January",a[1]="February",a[2]="March",a[3]="April",a[4]="May",a[5]="June",a[6]="July",a[7]="August",a[8]="September",a[9]="October",a[10]="November",a[11]="December";for(var b=0;b<E.FacetCategories.length;b++){var c=E.FacetCategories[b];if(c.Type==PivotViewer.Models.FacetType.DateTime)for(var d=0;d<E.Items.length;d++)for(var e,f=E.Items[d],g=0;g<f.Facets.length;g++)if(f.Facets[g].Name==c.Name){e=f.Facets[g].FacetValues[0];var h=new Date(e.Value),i=h.getFullYear();Bucketize(i,c.yearBuckets,f.Id,new Date(i,0,0));var j=i-i%10;Bucketize(j+"s",c.decadeBuckets,f.Id,new Date(i,0,0));var k=h.getMonth();Bucketize(a[k]+", "+i,c.monthBuckets,f.Id,new Date(i,k,0));var l=h.getDate();Bucketize(a[k]+" "+l+", "+i,c.dayBuckets,f.Id,new Date(i,k,l));var m=h.getHours(),n=m>12?m-12+" pm":m+" am";Bucketize(a[k]+" "+l+", "+i+" "+n,c.hourBuckets,f.Id,new Date(i,k,l,m,0,0));var o=h.getMinutes();Bucketize(a[k]+" "+l+", "+i+" "+m+":"+o,c.minuteBuckets,f.Id,new Date(i,k,l,m,o,0));var p=h.getSeconds();Bucketize(a[k]+" "+l+", "+i+" "+m+":"+o+":"+p,c.secondBuckets,f.Id,new Date(i,k,l,m,o,p));break}c.decadeBuckets.sort(function(a,b){return a.StartDate-b.StartDate}),c.yearBuckets.sort(function(a,b){return a.StartDate-b.StartDate}),c.monthBuckets.sort(function(a,b){return a.StartDate-b.StartDate}),c.dayBuckets.sort(function(a,b){return a.StartDate-b.StartDate}),c.hourBuckets.sort(function(a,b){return a.StartDate-b.StartDate}),c.minuteBuckets.sort(function(a,b){return a.StartDate-b.StartDate}),c.secondBuckets.sort(function(a,b){return a.StartDate-b.StartDate})}},HideCustomDateRange=function(b){a("#pv-custom-range-"+b+"__Start").css("visibility","hidden"),a("#pv-custom-range-"+b+"__Finish").css("visibility","hidden"),a("#pv-custom-range-"+b+"__StartDate").datepicker("setDate",null),a("#pv-custom-range-"+b+"__FinishDate").datepicker("setDate",null),a("#pv-custom-range-"+b+"__FinishDate").datepicker("option","minDate",null),a("#pv-custom-range-"+b+"__StartDate").datepicker("option","minDate",null),a("#pv-custom-range-"+b+"__FinishDate").datepicker("option","maxDate",null),a("#pv-custom-range-"+b+"__StartDate").datepicker("option","maxDate",null)},GetCustomDateRange=function(b){var c,d,e,f,g=C[b],h=E.GetFacetCategoryByName(g);a("#pv-custom-range-"+b+"__Start").css("visibility","visible"),a("#pv-custom-range-"+b+"__Finish").css("visibility","visible"),a("#pv-custom-range-"+b+"__StartDate").datepicker({showOn:"button",changeMonth:!0,changeYear:!0,buttonText:"Show Date",buttonImageOnly:!0,buttonImage:"http://jqueryui.com/resources/demos/datepicker/images/calendar.gif"}),a("#pv-custom-range-"+b+"__FinishDate").datepicker({showOn:"button",changeMonth:!0,changeYear:!0,buttonText:"Show Date",buttonImageOnly:!0,buttonImage:"http://jqueryui.com/resources/demos/datepicker/images/calendar.gif"}),h.dayBuckets.length>0&&(e=h.dayBuckets[h.dayBuckets.length-1].StartDate,f=h.dayBuckets[0].StartDate,a("#pv-custom-range-"+b+"__StartDate").datepicker("option","defaultDate",f),a("#pv-custom-range-"+b+"__FinishDate").datepicker("option","defaultDate",e),h.yearBuckets.length>0&&(c=h.yearBuckets[h.yearBuckets.length-1].Name,d=h.yearBuckets[0].Name,a("#pv-custom-range-"+b+"__StartDate").datepicker("option","yearRange",d+":"+c),a("#pv-custom-range-"+b+"__FinishDate").datepicker("option","yearRange",d+":"+c)))},CustomRangeChanged=function(b){var c,d;if("CustomRangeStart"==a(b).attr("itemvalue")?(c=a(b)[0].value,d=a("#pv-custom-range-"+a(b).attr("itemfacet")+"__FinishDate")[0].value,""==d&&a("#pv-custom-range-"+a(b).attr("itemfacet")+"__FinishDate").datepicker("option","minDate",new Date(c))):"CustomRangeFinish"==a(b).attr("itemvalue")&&(d=a(b)[0].value,c=a("#pv-custom-range-"+a(b).attr("itemfacet")+"__StartDate")[0].value,""==c&&a("#pv-custom-range-"+a(b).attr("itemfacet")+"__StartDate").datepicker("option","maxDate",new Date(d))),c&&d){for(var e=a(b.parentElement.parentElement.parentElement.parentElement.children).next().find(".pv-facet-facetitem:checked"),f=0;f<e.length;f++)"CustomRange"!=a(e[f]).attr("itemvalue")&&a(e[f]).prop("checked",!1);FilterCollection(!1)}},a.fn.PivotViewer=function(b){return F[b]?F[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?void a.error("Method "+b+" does not exist on jQuery.PivotViewer"):F.init.apply(this,arguments)}}(jQuery);